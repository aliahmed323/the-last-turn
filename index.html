<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Last Turn</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        const app = initializeApp({ apiKey: "AIzaSyBpMhO7a6p4ktKjoEta1MOTSLF345eIsRQ", authDomain: "the-last-turn.firebaseapp.com", projectId: "the-last-turn", storageBucket: "the-last-turn.firebasestorage.app", messagingSenderId: "747668413856", appId: "1:747668413856:web:6c67a8b56e7bdec53d58c5" });
        window.fb = { auth: getAuth(app), db: getFirestore(app), provider: new GoogleAuthProvider(), signInWithPopup, onAuthStateChanged, signOut, doc, setDoc, onSnapshot };
        window.dispatchEvent(new Event('fb-ready'));
    </script>
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
            box-sizing: border-box
        }

        body {
            background: #0f0f15;
            min-height: 100vh;
            margin: 0
        }

        .glass {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px
        }

        .chapter-card {
            background: linear-gradient(135deg, rgba(40, 40, 60, 0.9), rgba(30, 30, 50, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            transition: all 0.3s
        }

        .chapter-card:hover {
            border-color: rgba(139, 92, 246, 0.3)
        }

        .chapter-card.ignored {
            opacity: 0.4
        }

        .lecture-row {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin: 8px 0;
            padding: 14px 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .lecture-row:hover {
            background: rgba(139, 92, 246, 0.1)
        }

        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4)
        }

        .progress-bar {
            height: 8px;
            background: #1f1f2e;
            border-radius: 4px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s
        }

        .progress-purple {
            background: linear-gradient(90deg, #8b5cf6, #a855f7)
        }

        .progress-cyan {
            background: linear-gradient(90deg, #06b6d4, #22d3ee)
        }

        .progress-green {
            background: linear-gradient(90deg, #10b981, #34d399)
        }

        .sortable-ghost {
            opacity: 0.4;
            background: #8b5cf6 !important
        }

        .sortable-drag {
            background: #1a1a2e !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5)
        }

        .drag-handle {
            cursor: grab;
            user-select: none
        }

        .drag-handle:active {
            cursor: grabbing
        }

        .tab-btn {
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 15px
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            color: #fff;
            border: 1px solid rgba(139, 92, 246, 0.3)
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(40, 40, 60, 0.8), rgba(30, 30, 50, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px
        }

        .task-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            padding: 16px;
            margin: 10px 0
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 16px
        }

        .tag-red {
            background: #ef4444;
            color: #fff
        }

        .tag-green {
            background: #10b981;
            color: #fff
        }

        .tag-none {
            background: #374151;
            color: #9ca3af
        }

        input,
        select,
        textarea {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 18px;
            color: #fff;
            width: 100%;
            outline: none;
            font-size: 15px
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #8b5cf6
        }

        ::-webkit-scrollbar {
            width: 8px
        }

        ::-webkit-scrollbar-track {
            background: #0f0f15
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px
        }

        .chapter-header {
            cursor: pointer;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            border-radius: 20px
        }

        .chapter-header:hover {
            background: rgba(255, 255, 255, 0.03)
        }
    </style>
</head>

<body class="text-white" x-data="app()" x-init="init()">

    <!-- Loading -->
    <div x-show="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f0f15]">
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Login -->
    <div x-show="!user&&!loading" x-transition
        class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-[#0f0f15]">
        <div class="glass p-10 text-center max-w-md">
            <div
                class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-5xl shadow-lg shadow-purple-500/30">
                ğŸ“š</div>
            <h1
                class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">
                The Last Turn</h1>
            <p class="text-gray-400 mb-8">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
            <button @click="login()" class="btn btn-primary w-full py-4 text-lg">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
        </div>
    </div>

    <!-- Main App -->
    <div x-show="user&&!loading" x-transition class="min-h-screen">

        <!-- Header -->
        <header class="sticky top-0 z-40 bg-[#0f0f15]/90 backdrop-blur-lg border-b border-white/5">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ“š</span>
                    <span
                        class="font-bold text-xl bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">The
                        Last Turn</span>
                </div>
                <nav class="flex gap-2 flex-wrap">
                    <button @click="tab='dashboard'" :class="tab==='dashboard'?'active':''" class="tab-btn">ğŸ“Š Ù„ÙˆØ­Ø©
                        Ø§Ù„ØªØ­ÙƒÙ…</button>
                    <button @click="tab='medicine'" :class="tab==='medicine'?'active':''" class="tab-btn">ğŸ«€
                        Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</button>
                    <button @click="tab='pediatrics'" :class="tab==='pediatrics'?'active':''" class="tab-btn">ğŸ‘¶
                        Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
                    <button @click="tab='tags'" :class="tab==='tags'?'active':''" class="tab-btn">ğŸ·ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</button>
                    <button @click="tab='settings'" :class="tab==='settings'?'active':''" class="tab-btn">âš™ï¸</button>
                </nav>
                <div class="flex items-center gap-3">
                    <img :src="user?.photoURL" class="w-10 h-10 rounded-full border-2 border-purple-500"
                        alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <button @click="logout()" class="text-sm text-gray-400 hover:text-white">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">

            <!-- Dashboard -->
            <div x-show="tab==='dashboard'" x-transition>
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">â° Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†</p>
                        <p class="text-4xl font-bold text-purple-400" x-text="daysToExam"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ“… Ø£ÙŠØ§Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                        <p class="text-4xl font-bold text-blue-400" x-text="planDaysRemaining"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                        <p class="text-3xl font-bold text-orange-400" x-text="dailyRequired.toFixed(1)+' Ø³Ø§Ø¹Ø©'"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ</p>
                        <p class="text-4xl font-bold text-green-400" x-text="totalProgress+'%'"></p>
                        <div class="progress-bar mt-3">
                            <div class="progress-fill progress-green" :style="'width:'+totalProgress+'%'"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">â±ï¸ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</p>
                        <p class="text-2xl font-bold"><span class="text-cyan-400" x-text="hoursDone"></span> / <span
                                class="text-gray-500" x-text="totalHours"></span></p>
                    </div>
                </div>

                <!-- Progress Bars -->
                <div class="grid md:grid-cols-2 gap-4 mb-8">
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-lg">ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</span>
                            <span class="text-purple-400 font-bold" x-text="getProgress('medicine')+'%'"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-purple" :style="'width:'+getProgress('medicine')+'%'">
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2"
                            x-text="'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ: '+getDailyRequired('medicine').toFixed(1)+' Ø³Ø§Ø¹Ø©'"></p>
                    </div>
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-lg">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„</span>
                            <span class="text-cyan-400 font-bold" x-text="getProgress('pediatrics')+'%'"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-cyan" :style="'width:'+getProgress('pediatrics')+'%'">
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2"
                            x-text="'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ: '+getDailyRequired('pediatrics').toFixed(1)+' Ø³Ø§Ø¹Ø©'"></p>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Medicine Tasks -->
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-purple-400 text-lg">ğŸ«€ Ù…Ù‡Ø§Ù… Ø§Ù„Ø¨Ø§Ø·Ù†Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
                            <span class="text-sm text-gray-500" x-text="getTodayTasksTime('medicine')+' Ø¯Ù‚ÙŠÙ‚Ø©'"></span>
                        </div>
                        <div x-show="getTodayTasks('medicine').length===0" class="text-center py-8 text-gray-500">
                            <span class="text-4xl">âœ…</span>
                            <p class="mt-2">Ø£Ù†Ø¬Ø²Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…!</p>
                        </div>
                        <template x-for="task in getTodayTasks('medicine')" :key="task.id">
                            <div class="task-card flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="font-medium text-base" x-text="task.title"></p>
                                    <p class="text-sm text-gray-400" x-text="task.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+task.chapter">
                                    </p>
                                </div>
                                <button @click="markDone(task)"
                                    class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition text-xl">âœ“</button>
                            </div>
                        </template>
                    </div>
                    <!-- Pediatrics Tasks -->
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-cyan-400 text-lg">ğŸ‘¶ Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                            <span class="text-sm text-gray-500"
                                x-text="getTodayTasksTime('pediatrics')+' Ø¯Ù‚ÙŠÙ‚Ø©'"></span>
                        </div>
                        <div x-show="getTodayTasks('pediatrics').length===0" class="text-center py-8 text-gray-500">
                            <span class="text-4xl">âœ…</span>
                            <p class="mt-2">Ø£Ù†Ø¬Ø²Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…!</p>
                        </div>
                        <template x-for="task in getTodayTasks('pediatrics')" :key="task.id">
                            <div class="task-card flex items-center justify-between"
                                style="border-color:rgba(6,182,212,0.2);background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(6,182,212,0.05))">
                                <div class="flex-1">
                                    <p class="font-medium text-base" x-text="task.title"></p>
                                    <p class="text-sm text-gray-400" x-text="task.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+task.chapter">
                                    </p>
                                </div>
                                <button @click="markDone(task)"
                                    class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition text-xl">âœ“</button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Delay Alert -->
                <div x-show="delayHours>0" class="stat-card border-red-500/50 bg-red-500/5">
                    <div class="flex items-start gap-4">
                        <span class="text-5xl">âš ï¸</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-red-400 mb-2">Ø£Ù†Øª Ù…ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø®Ø·Ø©!</h3>
                            <p class="text-gray-300 mb-3">Ù…ØªØ£Ø®Ø± Ø¨Ù€ <span class="text-red-400 font-bold text-xl"
                                    x-text="delayHours.toFixed(1)"></span> Ø³Ø§Ø¹Ø©</p>
                            <div class="bg-black/30 rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Ù„Ù„ØªØ¹ÙˆÙŠØ¶ØŒ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ÙŠÙˆÙ…ÙŠØ§Ù‹:</p>
                                <p class="text-3xl font-bold text-orange-400" x-text="extraMinutes+' Ø¯Ù‚ÙŠÙ‚Ø©'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subject Views -->
            <template x-for="subj in ['medicine','pediatrics']" :key="subj">
                <div x-show="tab===subj" x-transition>
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold" x-text="subj==='medicine'?'ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„'"></h2>
                            <p class="text-gray-400 mt-1"
                                x-text="'Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: '+getStats(subj).done+'/'+getStats(subj).total+' â€¢ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: '+getStats(subj).hDone+'/'+getStats(subj).hTotal">
                            </p>
                        </div>
                        <div class="text-left">
                            <p class="text-4xl font-bold" :class="subj==='medicine'?'text-purple-400':'text-cyan-400'"
                                x-text="getProgress(subj)+'%'"></p>
                            <p class="text-sm text-gray-500">Ù…ÙƒØªÙ…Ù„</p>
                        </div>
                    </div>

                    <p class="text-sm text-gray-500 mb-4">ğŸ’¡ Ø§Ø³Ø­Ø¨ â˜° Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>

                    <!-- Chapters List -->
                    <div :id="subj+'-chapters'" class="space-y-5">
                        <template x-for="(ch,ci) in data[subj]" :key="ch.id">
                            <div class="chapter-card" :class="ch.ignored?'ignored':''" :data-id="ch.id">
                                <!-- Chapter Header - Entire area clickable -->
                                <div class="chapter-header" @click="toggleCh(subj,ci)">
                                    <div class="flex items-center gap-4">
                                        <span class="drag-handle text-xl px-3 py-2 bg-gray-700/50 rounded-lg"
                                            @click.stop title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨">â˜°</span>
                                        <span class="text-3xl" x-text="ch.icon">ğŸ“š</span>
                                        <div>
                                            <h3 class="font-bold text-xl" x-text="ch.name"></h3>
                                            <p class="text-sm text-gray-400"
                                                x-text="getChProg(subj,ci)+'% Ù…ÙƒØªÙ…Ù„ â€¢ '+ch.lectures.length+' Ù…Ø­Ø§Ø¶Ø±Ø© â€¢ '+getChHrs(subj,ci)+' Ø³Ø§Ø¹Ø©'">
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-28 progress-bar hidden sm:block">
                                            <div class="progress-fill"
                                                :class="subj==='medicine'?'progress-purple':'progress-cyan'"
                                                :style="'width:'+getChProg(subj,ci)+'%'"></div>
                                        </div>
                                        <button @click.stop="ch.ignored=!ch.ignored;save()" class="icon-btn"
                                            :class="ch.ignored?'bg-gray-500 text-white':'bg-gray-700/50 text-gray-400'"
                                            title="ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØµÙ„">ğŸ‘</button>
                                        <button @click.stop="deleteChapter(subj,ci)"
                                            class="icon-btn bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"
                                            title="Ø­Ø°Ù Ø§Ù„ÙØµÙ„">ğŸ—‘ï¸</button>
                                        <span class="text-gray-400 text-lg" x-text="openCh[subj+ci]?'â–²':'â–¼'"></span>
                                    </div>
                                </div>
                                <!-- Lectures -->
                                <div x-show="openCh[subj+ci]" x-transition
                                    class="px-5 pb-5 border-t border-white/5 pt-4">
                                    <div :id="'lec-'+ch.id" class="space-y-2">
                                        <template x-for="(lec,li) in ch.lectures" :key="lec.id">
                                            <div class="lecture-row" :class="lec.done?'opacity-50':''"
                                                :data-id="lec.id">
                                                <div class="flex items-center gap-3 flex-1">
                                                    <span
                                                        class="drag-handle text-sm px-2 py-1 bg-gray-700/50 rounded cursor-grab"
                                                        title="Ø§Ø³Ø­Ø¨">â˜°</span>
                                                    <span
                                                        class="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-bold"
                                                        :class="lec.done?'bg-green-500 text-white':'bg-gray-700 text-gray-300'"
                                                        x-text="li+1"></span>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="font-medium text-base"
                                                            :class="lec.done?'line-through text-gray-500':''"
                                                            x-text="lec.title"></p>
                                                        <p class="text-sm text-gray-500" x-text="lec.duration+' Ø¯Ù‚ÙŠÙ‚Ø©'">
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-2 mr-4">
                                                    <button @click="lec.done=!lec.done;save()" class="icon-btn"
                                                        :class="lec.done?'bg-green-500 text-white':'tag-none'"
                                                        title="Ù…ÙƒØªÙ…Ù„">âœ“</button>
                                                    <button @click="cycleTag(lec)" class="icon-btn"
                                                        :class="lec.tag==='review'?'tag-red':lec.tag==='mastered'?'tag-green':'tag-none'"
                                                        :title="lec.tag==='review'?'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©':lec.tag==='mastered'?'Ù…ØªÙ‚Ù†':'Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø©'">
                                                        <span
                                                            x-text="lec.tag==='review'?'ğŸ”´':lec.tag==='mastered'?'ğŸŸ¢':'âšª'"></span>
                                                    </button>
                                                    <button @click="deleteLecture(subj,ci,li)"
                                                        class="icon-btn bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"
                                                        title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Tags View -->
            <div x-show="tab==='tags'" x-transition>
                <h2 class="text-3xl font-bold mb-6">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</h2>

                <!-- Review Needed (Red) -->
                <div class="stat-card mb-6 border-red-500/30">
                    <h3 class="font-bold text-red-400 text-xl mb-4">ğŸ”´ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© (<span
                            x-text="getTaggedLectures('review').length"></span>)</h3>
                    <div x-show="getTaggedLectures('review').length===0" class="text-center py-6 text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©
                    </div>
                    <template x-for="item in getTaggedLectures('review')" :key="item.id">
                        <div class="lecture-row flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-medium" x-text="item.title"></p>
                                <p class="text-sm text-gray-500"
                                    x-text="item.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+item.chapter+' â€¢ '+(item.subject==='medicine'?'Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'Ø§Ù„Ø£Ø·ÙØ§Ù„')">
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="setTag(item,'mastered')" class="icon-btn tag-green"
                                    title="ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†">ğŸŸ¢</button>
                                <button @click="setTag(item,'none')" class="icon-btn tag-none"
                                    title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©">âšª</button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Mastered (Green) -->
                <div class="stat-card border-green-500/30">
                    <h3 class="font-bold text-green-400 text-xl mb-4">ğŸŸ¢ ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù† (<span
                            x-text="getTaggedLectures('mastered').length"></span>)</h3>
                    <div x-show="getTaggedLectures('mastered').length===0" class="text-center py-6 text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªÙ‚Ù†Ø©
                    </div>
                    <template x-for="item in getTaggedLectures('mastered')" :key="item.id">
                        <div class="lecture-row flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-medium" x-text="item.title"></p>
                                <p class="text-sm text-gray-500"
                                    x-text="item.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+item.chapter+' â€¢ '+(item.subject==='medicine'?'Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'Ø§Ù„Ø£Ø·ÙØ§Ù„')">
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="setTag(item,'review')" class="icon-btn tag-red"
                                    title="ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©">ğŸ”´</button>
                                <button @click="setTag(item,'none')" class="icon-btn tag-none"
                                    title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©">âšª</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Settings -->
            <div x-show="tab==='settings'" x-transition class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

                <div class="space-y-4">
                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label>
                        <input type="date" x-model="settings.examDate" @change="save()">
                    </div>
                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©</label>
                        <input type="date" x-model="settings.planEndDate" @change="save()">
                        <p class="text-xs text-gray-500 mt-2">Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                    </div>

                    <!-- Smart Parser -->
                    <div class="stat-card border-purple-500/30">
                        <h3 class="font-bold text-purple-400 mb-4 text-lg">ğŸ“¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3>

                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                                <select x-model="parser.subject" @change="parser.chapter=''">
                                    <option value="medicine">ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</option>
                                    <option value="pediatrics">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ø®ØªØ± ÙØµÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙŠØ¯</label>
                                <select x-model="parser.chapter">
                                    <option value="">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯...</option>
                                    <template x-for="ch in data[parser.subject]" :key="ch.id">
                                        <option :value="ch.id" x-text="ch.icon+' '+ch.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div x-show="parser.chapter===''">
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                                <input type="text" x-model="parser.newName" placeholder="Ù…Ø«Ù„: Cardiology">
                            </div>
                            <div x-show="parser.chapter===''">
                                <label class="text-sm text-gray-500 mb-1 block">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØµÙ„</label>
                                <input type="text" x-model="parser.newIcon" placeholder="Ù…Ø«Ù„: â¤ï¸">
                            </div>

                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª (ÙƒÙ„ Ø³Ø·Ø±: Ø§Ø³Ù… - Ù…Ø¯Ø©)</label>
                                <textarea x-model="parser.text" rows="5" placeholder="Lecture 1 - 30
Lecture 2 - 45
Lecture 3 - 60"></textarea>
                            </div>

                            <button @click="parseAndAdd()" class="btn btn-primary w-full py-3">â• Ø¥Ø¶Ø§ÙØ©
                                Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="stat-card border-yellow-500/30">
                        <button @click="forceReload()" class="text-yellow-400 font-bold">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                        <p class="text-sm text-gray-500 mt-1">Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙØ§Ø±ØºØ©</p>
                    </div>
                    <div class="stat-card border-red-500/30">
                        <button @click="resetAll()" class="text-red-400 font-bold">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const DEFAULT_DATA = {
            medicine: [
                {
                    id: 'm1', name: 'Neurology', icon: 'ğŸ§ ', ignored: false, lectures: [
                        { id: 'm1a', title: 'Neurology Intro', duration: 30, done: false, tag: 'none' },
                        { id: 'm1b', title: 'Stroke Part 1', duration: 45, done: false, tag: 'none' },
                        { id: 'm1c', title: 'Stroke Part 2', duration: 40, done: false, tag: 'none' },
                        { id: 'm1d', title: 'Epilepsy', duration: 50, done: false, tag: 'none' },
                        { id: 'm1e', title: 'Headache', duration: 35, done: false, tag: 'none' },
                        { id: 'm1f', title: 'Multiple Sclerosis', duration: 40, done: false, tag: 'none' },
                        { id: 'm1g', title: 'CNS Infections', duration: 55, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm2', name: 'Cardiology', icon: 'â¤ï¸', ignored: false, lectures: [
                        { id: 'm2a', title: 'Cardiology Basics', duration: 30, done: false, tag: 'none' },
                        { id: 'm2b', title: 'Ischemic Heart Disease', duration: 60, done: false, tag: 'none' },
                        { id: 'm2c', title: 'Heart Failure', duration: 55, done: false, tag: 'none' },
                        { id: 'm2d', title: 'Arrhythmia', duration: 45, done: false, tag: 'none' },
                        { id: 'm2e', title: 'Valvular Heart Disease', duration: 50, done: false, tag: 'none' },
                        { id: 'm2f', title: 'Hypertension', duration: 40, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm3', name: 'Nephrology', icon: 'ğŸ«˜', ignored: false, lectures: [
                        { id: 'm3a', title: 'Nephrology Intro', duration: 30, done: false, tag: 'none' },
                        { id: 'm3b', title: 'Acute Kidney Injury', duration: 45, done: false, tag: 'none' },
                        { id: 'm3c', title: 'Chronic Kidney Disease', duration: 50, done: false, tag: 'none' },
                        { id: 'm3d', title: 'Glomerulonephritis', duration: 60, done: false, tag: 'none' },
                        { id: 'm3e', title: 'Acid Base Balance', duration: 40, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm4', name: 'Endocrinology', icon: 'ğŸ¦‹', ignored: false, lectures: [
                        { id: 'm4a', title: 'Diabetes Part 1', duration: 45, done: false, tag: 'none' },
                        { id: 'm4b', title: 'Diabetes Part 2', duration: 45, done: false, tag: 'none' },
                        { id: 'm4c', title: 'Thyroid Disorders', duration: 50, done: false, tag: 'none' },
                        { id: 'm4d', title: 'Adrenal Gland', duration: 40, done: false, tag: 'none' },
                        { id: 'm4e', title: 'Pituitary Disorders', duration: 35, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm5', name: 'Hematology', icon: 'ğŸ©¸', ignored: false, lectures: [
                        { id: 'm5a', title: 'Anemia Approach', duration: 30, done: false, tag: 'none' },
                        { id: 'm5b', title: 'Iron Deficiency', duration: 25, done: false, tag: 'none' },
                        { id: 'm5c', title: 'Hemolytic Anemia', duration: 40, done: false, tag: 'none' },
                        { id: 'm5d', title: 'Leukemia', duration: 50, done: false, tag: 'none' },
                        { id: 'm5e', title: 'Lymphoma', duration: 45, done: false, tag: 'none' },
                        { id: 'm5f', title: 'Bleeding Disorders', duration: 40, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm6', name: 'Pulmonology', icon: 'ğŸ«', ignored: false, lectures: [
                        { id: 'm6a', title: 'Pneumonia', duration: 45, done: false, tag: 'none' },
                        { id: 'm6b', title: 'Asthma', duration: 40, done: false, tag: 'none' },
                        { id: 'm6c', title: 'COPD', duration: 35, done: false, tag: 'none' },
                        { id: 'm6d', title: 'TB', duration: 40, done: false, tag: 'none' },
                        { id: 'm6e', title: 'Pleural Effusion', duration: 30, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm7', name: 'Gastroenterology', icon: 'ğŸ«ƒ', ignored: false, lectures: [
                        { id: 'm7a', title: 'Liver Cirrhosis', duration: 50, done: false, tag: 'none' },
                        { id: 'm7b', title: 'Hepatitis', duration: 45, done: false, tag: 'none' },
                        { id: 'm7c', title: 'IBD', duration: 40, done: false, tag: 'none' },
                        { id: 'm7d', title: 'Peptic Ulcer', duration: 30, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'm8', name: 'Rheumatology', icon: 'ğŸ¦´', ignored: false, lectures: [
                        { id: 'm8a', title: 'SLE', duration: 45, done: false, tag: 'none' },
                        { id: 'm8b', title: 'Rheumatoid Arthritis', duration: 40, done: false, tag: 'none' },
                        { id: 'm8c', title: 'Vasculitis', duration: 35, done: false, tag: 'none' }
                    ]
                }
            ],
            pediatrics: [
                {
                    id: 'p1', name: 'Endocrinology', icon: 'ğŸ¦‹', ignored: false, lectures: [
                        { id: 'p1a', title: 'Rickets', duration: 31, done: false, tag: 'none' },
                        { id: 'p1b', title: 'Hypoglycemia', duration: 20, done: false, tag: 'none' },
                        { id: 'p1c', title: 'Growth', duration: 21, done: false, tag: 'none' },
                        { id: 'p1d', title: 'Diabetes Part 1', duration: 39, done: false, tag: 'none' },
                        { id: 'p1e', title: 'Diabetes Part 2', duration: 41, done: false, tag: 'none' },
                        { id: 'p1f', title: 'DKA', duration: 42, done: false, tag: 'none' },
                        { id: 'p1g', title: 'Thyroid Disorders', duration: 56, done: false, tag: 'none' },
                        { id: 'p1h', title: 'Short Stature', duration: 17, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'p2', name: 'Neurology', icon: 'ğŸ§ ', ignored: false, lectures: [
                        { id: 'p2a', title: 'Meningitis Part 1', duration: 28, done: false, tag: 'none' },
                        { id: 'p2b', title: 'Guillain Barre', duration: 26, done: false, tag: 'none' },
                        { id: 'p2c', title: 'Cerebral Palsy', duration: 36, done: false, tag: 'none' },
                        { id: 'p2d', title: 'Seizures Part 1', duration: 30, done: false, tag: 'none' },
                        { id: 'p2e', title: 'Seizures Part 2', duration: 25, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'p3', name: 'Hematology', icon: 'ğŸ©¸', ignored: false, lectures: [
                        { id: 'p3a', title: 'Anemia Approach', duration: 25, done: false, tag: 'none' },
                        { id: 'p3b', title: 'Iron Deficiency', duration: 25, done: false, tag: 'none' },
                        { id: 'p3c', title: 'Thalassemia', duration: 30, done: false, tag: 'none' },
                        { id: 'p3d', title: 'Sickle Cell', duration: 23, done: false, tag: 'none' },
                        { id: 'p3e', title: 'Leukemia', duration: 28, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'p4', name: 'Neonatology', icon: 'ğŸ‘¶', ignored: false, lectures: [
                        { id: 'p4a', title: 'Neonatal Sepsis', duration: 42, done: false, tag: 'none' },
                        { id: 'p4b', title: 'Respiratory Distress', duration: 32, done: false, tag: 'none' },
                        { id: 'p4c', title: 'Prematurity', duration: 32, done: false, tag: 'none' },
                        { id: 'p4d', title: 'Neonatal Seizures', duration: 31, done: false, tag: 'none' },
                        { id: 'p4e', title: 'HIE', duration: 40, done: false, tag: 'none' },
                        { id: 'p4f', title: 'Neonatal Exam', duration: 97, done: false, tag: 'none' }
                    ]
                },
                {
                    id: 'p5', name: 'Emergency', icon: 'ğŸš¨', ignored: false, lectures: [
                        { id: 'p5a', title: 'Pediatric PLS', duration: 22, done: false, tag: 'none' },
                        { id: 'p5b', title: 'PALS', duration: 10, done: false, tag: 'none' },
                        { id: 'p5c', title: 'Anaphylaxis', duration: 9, done: false, tag: 'none' },
                        { id: 'p5d', title: 'Poisoning', duration: 20, done: false, tag: 'none' },
                        { id: 'p5e', title: 'Dehydration', duration: 40, done: false, tag: 'none' },
                        { id: 'p5f', title: 'Gastroenteritis', duration: 30, done: false, tag: 'none' }
                    ]
                }
            ]
        };

        function app() {
            return {
                loading: true,
                user: null,
                tab: 'dashboard',
                unsub: null,
                openCh: {},
                settings: { examDate: '2026-04-15', planEndDate: '2026-04-01' },
                parser: { subject: 'medicine', chapter: '', newName: '', newIcon: 'ğŸ“š', text: '' },
                data: { medicine: [], pediatrics: [] },

                async init() {
                    this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    const setup = () => {
                        window.fb.onAuthStateChanged(window.fb.auth, async (u) => {
                            this.user = u;
                            if (u) await this.load();
                            this.loading = false;
                            this.$nextTick(() => this.initSortable());
                        });
                    };
                    if (window.fb) setup();
                    else window.addEventListener('fb-ready', setup);
                },

                async login() {
                    try { await window.fb.signInWithPopup(window.fb.auth, window.fb.provider); }
                    catch (e) { alert('Ø®Ø·Ø£: ' + e.message); }
                },

                async logout() {
                    if (this.unsub) this.unsub();
                    await window.fb.signOut(window.fb.auth);
                    this.user = null;
                },

                async load() {
                    const ref = window.fb.doc(window.fb.db, 'users', this.user.uid);
                    this.unsub = window.fb.onSnapshot(ref, (doc) => {
                        if (doc.exists()) {
                            const d = doc.data();
                            if (d.data && d.data.medicine && d.data.medicine.length > 0) {
                                this.data = d.data;
                            }
                            if (d.settings) this.settings = { ...this.settings, ...d.settings };
                        } else {
                            this.save();
                        }
                        this.$nextTick(() => this.initSortable());
                    });
                },

                async save() {
                    if (!this.user) return;
                    await window.fb.setDoc(window.fb.doc(window.fb.db, 'users', this.user.uid), {
                        data: JSON.parse(JSON.stringify(this.data)),
                        settings: this.settings
                    }, { merge: true });
                },

                initSortable() {
                    const self = this;
                    ['medicine', 'pediatrics'].forEach(subj => {
                        const el = document.getElementById(subj + '-chapters');
                        if (el && !el._sortable) {
                            el._sortable = new Sortable(el, {
                                handle: '.drag-handle',
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                onEnd: () => {
                                    const items = [...el.querySelectorAll('[data-id]')].map(e => e.dataset.id);
                                    const newOrder = items.map(id => self.data[subj].find(ch => ch.id === id)).filter(Boolean);
                                    self.data[subj] = newOrder;
                                    self.save();
                                }
                            });
                        }
                    });
                    ['medicine', 'pediatrics'].forEach(subj => {
                        this.data[subj].forEach((ch) => {
                            const el = document.getElementById('lec-' + ch.id);
                            if (el && !el._sortable) {
                                el._sortable = new Sortable(el, {
                                    handle: '.drag-handle',
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    onEnd: () => {
                                        const items = [...el.querySelectorAll('[data-id]')].map(e => e.dataset.id);
                                        const newOrder = items.map(id => ch.lectures.find(l => l.id === id)).filter(Boolean);
                                        ch.lectures = newOrder;
                                        self.save();
                                    }
                                });
                            }
                        });
                    });
                },

                toggleCh(subj, i) {
                    this.openCh[subj + i] = !this.openCh[subj + i];
                    this.$nextTick(() => this.initSortable());
                },

                deleteChapter(subj, ci) {
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙ‡ØŸ')) {
                        this.data[subj].splice(ci, 1);
                        this.save();
                    }
                },

                deleteLecture(subj, ci, li) {
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ')) {
                        this.data[subj][ci].lectures.splice(li, 1);
                        this.save();
                    }
                },

                // Tags
                cycleTag(lec) {
                    if (!lec.tag || lec.tag === 'none') lec.tag = 'review';
                    else if (lec.tag === 'review') lec.tag = 'mastered';
                    else lec.tag = 'none';
                    this.save();
                },

                setTag(item, tag) {
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s]) {
                            for (const l of ch.lectures) {
                                if (l.id === item.id) { l.tag = tag; this.save(); return; }
                            }
                        }
                    }
                },

                getTaggedLectures(tag) {
                    const list = [];
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s] || []) {
                            for (const l of ch.lectures || []) {
                                if (l.tag === tag) {
                                    list.push({ ...l, subject: s, chapter: ch.name });
                                }
                            }
                        }
                    }
                    return list;
                },

                // Calculations
                get daysToExam() { return Math.max(0, Math.ceil((new Date(this.settings.examDate) - new Date()) / 86400000)); },
                get planDaysRemaining() { return Math.max(1, Math.ceil((new Date(this.settings.planEndDate) - new Date()) / 86400000)); },
                get daysPassed() { return Math.max(0, Math.ceil((new Date() - new Date(this.settings.startDate || '2026-02-01')) / 86400000)); },

                getRemainingHours(subj) {
                    let t = 0;
                    this.data[subj]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => { if (!l.done) t += l.duration; }); });
                    return t / 60;
                },

                getDailyRequired(subj) {
                    const remaining = this.getRemainingHours(subj);
                    return remaining / this.planDaysRemaining;
                },

                get dailyRequired() {
                    return this.getDailyRequired('medicine') + this.getDailyRequired('pediatrics');
                },

                get totalHours() {
                    let t = 0;
                    ['medicine', 'pediatrics'].forEach(s => this.data[s]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => t += l.duration); }));
                    return (t / 60).toFixed(1);
                },
                get hoursDone() {
                    let t = 0;
                    ['medicine', 'pediatrics'].forEach(s => this.data[s]?.forEach(c => c.lectures?.forEach(l => { if (l.done) t += l.duration; })));
                    return (t / 60).toFixed(1);
                },
                get totalProgress() {
                    const t = parseFloat(this.totalHours), d = parseFloat(this.hoursDone);
                    return t > 0 ? Math.round(d / t * 100) : 0;
                },

                getProgress(subj) {
                    let t = 0, d = 0;
                    this.data[subj]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => { t++; if (l.done) d++; }); });
                    return t > 0 ? Math.round(d / t * 100) : 0;
                },
                getStats(subj) {
                    let t = 0, d = 0, ht = 0, hd = 0;
                    this.data[subj]?.forEach(c => c.lectures?.forEach(l => { t++; ht += l.duration; if (l.done) { d++; hd += l.duration; } }));
                    return { total: t, done: d, hTotal: (ht / 60).toFixed(1), hDone: (hd / 60).toFixed(1) };
                },
                getChProg(subj, i) {
                    const ch = this.data[subj]?.[i];
                    if (!ch || !ch.lectures?.length) return 0;
                    return Math.round(ch.lectures.filter(l => l.done).length / ch.lectures.length * 100);
                },
                getChHrs(subj, i) {
                    const ch = this.data[subj]?.[i];
                    if (!ch) return '0';
                    return (ch.lectures?.reduce((a, l) => a + l.duration, 0) / 60).toFixed(1);
                },

                get expectedHours() {
                    const total = this.daysPassed + this.daysToExam;
                    if (!total) return 0;
                    return (parseFloat(this.totalHours) / total) * this.daysPassed;
                },
                get delayHours() { return Math.max(0, this.expectedHours - parseFloat(this.hoursDone)); },
                get extraMinutes() { return this.daysToExam > 0 ? Math.round(this.delayHours * 60 / this.daysToExam) : 0; },

                // Daily Tasks - New Algorithm
                getTodayTasks(subj) {
                    const tasks = [];
                    let totalMins = 0;
                    const targetMins = this.getDailyRequired(subj) * 60;

                    // Go through chapters in order (first = top priority)
                    for (const ch of (this.data[subj] || [])) {
                        if (ch.ignored) continue;

                        // Go through lectures in order
                        for (const l of (ch.lectures || [])) {
                            if (l.done) continue;

                            // Check if adding this would exceed target significantly
                            if (totalMins >= targetMins) {
                                // Already have enough, but check if we should add one more
                                // (lean towards more rather than less)
                                const diff = totalMins - targetMins;
                                if (diff > 30) break; // Already have 30+ extra minutes, stop
                            }

                            tasks.push({ ...l, subject: subj, chapter: ch.name, chapterId: ch.id });
                            totalMins += l.duration;

                            // If we've gone way over (more than 60 mins over target), stop
                            if (totalMins > targetMins + 60) break;
                        }

                        if (totalMins > targetMins + 60) break;
                    }

                    return tasks;
                },

                getTodayTasksTime(subj) {
                    return this.getTodayTasks(subj).reduce((a, t) => a + t.duration, 0);
                },

                markDone(task) {
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of (this.data[s] || [])) {
                            for (const l of (ch.lectures || [])) {
                                if (l.id === task.id) { l.done = true; this.save(); return; }
                            }
                        }
                    }
                },

                forceReload() {
                    this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    this.save();
                    this.$nextTick(() => this.initSortable());
                    alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©!');
                },

                resetAll() {
                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                        this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                        this.save();
                    }
                },

                parseAndAdd() {
                    if (!this.parser.text.trim()) {
                        alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª');
                        return;
                    }

                    const lines = this.parser.text.trim().split('\n');
                    const newLectures = lines.map((line, i) => {
                        const parts = line.split('-');
                        return {
                            id: 'lec_' + Date.now() + '_' + i,
                            title: parts[0]?.trim() || 'Ù…Ø­Ø§Ø¶Ø±Ø©',
                            duration: parseInt(parts[1]) || 30,
                            done: false,
                            tag: 'none'
                        };
                    });

                    if (this.parser.chapter) {
                        const ch = this.data[this.parser.subject].find(c => c.id === this.parser.chapter);
                        if (ch) {
                            ch.lectures.push(...newLectures);
                            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + newLectures.length + ' Ù…Ø­Ø§Ø¶Ø±Ø© Ø¥Ù„Ù‰ ' + ch.name);
                        }
                    } else {
                        if (!this.parser.newName) {
                            alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
                            return;
                        }
                        const newChapter = {
                            id: 'ch_' + Date.now(),
                            name: this.parser.newName,
                            icon: this.parser.newIcon || 'ğŸ“š',
                            ignored: false,
                            lectures: newLectures
                        };
                        this.data[this.parser.subject].push(newChapter);
                        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯: ' + this.parser.newName + ' (' + newLectures.length + ' Ù…Ø­Ø§Ø¶Ø±Ø©)');
                    }

                    this.parser = { subject: this.parser.subject, chapter: '', newName: '', newIcon: 'ğŸ“š', text: '' };
                    this.save();
                    this.$nextTick(() => this.initSortable());
                }
            };
        }
    </script>
</body>

</html>