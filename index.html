<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Last Turn</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        const app = initializeApp({ apiKey: "AIzaSyBpMhO7a6p4ktKjoEta1MOTSLF345eIsRQ", authDomain: "the-last-turn.firebaseapp.com", projectId: "the-last-turn", storageBucket: "the-last-turn.firebasestorage.app", messagingSenderId: "747668413856", appId: "1:747668413856:web:6c67a8b56e7bdec53d58c5" });
        window.fb = { auth: getAuth(app), db: getFirestore(app), provider: new GoogleAuthProvider(), signInWithPopup, onAuthStateChanged, signOut, doc, setDoc, onSnapshot, collection, getDocs, getDoc };
        window.dispatchEvent(new Event('fb-ready'));
    </script>
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
            box-sizing: border-box
        }

        body {
            background: #0f0f15;
            min-height: 100vh;
            margin: 0
        }

        .glass {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px
        }

        .chapter-card {
            background: linear-gradient(135deg, rgba(40, 40, 60, 0.9), rgba(30, 30, 50, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            transition: all 0.3s
        }

        .chapter-card:hover {
            border-color: rgba(139, 92, 246, 0.3)
        }

        .chapter-card.ignored {
            opacity: 0.4
        }

        .lecture-row {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin: 8px 0;
            padding: 14px 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .lecture-row:hover {
            background: rgba(139, 92, 246, 0.1)
        }

        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4)
        }

        .progress-bar {
            height: 8px;
            background: #1f1f2e;
            border-radius: 4px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s
        }

        .progress-purple {
            background: linear-gradient(90deg, #8b5cf6, #a855f7)
        }

        .progress-cyan {
            background: linear-gradient(90deg, #06b6d4, #22d3ee)
        }

        .progress-green {
            background: linear-gradient(90deg, #10b981, #34d399)
        }

        .sortable-ghost {
            opacity: 0.4;
            background: #8b5cf6 !important
        }

        .sortable-drag {
            background: #1a1a2e !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5)
        }

        .drag-handle {
            cursor: grab;
            user-select: none
        }

        .drag-handle:active {
            cursor: grabbing
        }

        .tab-btn {
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 15px
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            color: #fff;
            border: 1px solid rgba(139, 92, 246, 0.3)
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(40, 40, 60, 0.8), rgba(30, 30, 50, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px
        }

        .task-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            padding: 16px;
            margin: 10px 0
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 16px
        }

        .tag-red {
            background: #ef4444;
            color: #fff
        }

        .tag-green {
            background: #10b981;
            color: #fff
        }

        .tag-none {
            background: #374151;
            color: #9ca3af
        }

        input,
        select,
        textarea {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 18px;
            color: #fff;
            width: 100%;
            outline: none;
            font-size: 15px
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #8b5cf6
        }

        ::-webkit-scrollbar {
            width: 8px
        }

        ::-webkit-scrollbar-track {
            background: #0f0f15
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px
        }

        .chapter-header {
            cursor: pointer;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            border-radius: 20px
        }

        .chapter-header:hover {
            background: rgba(255, 255, 255, 0.03)
        }

        .mini-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            text-align: center;
        }

        .hours-display {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
    </style>
</head>

<body class="text-white" x-data="app()" x-init="init()">

    <!-- Loading -->
    <div x-show="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f0f15]">
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Login -->
    <div x-show="!user&&!loading" x-transition
        class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-[#0f0f15]">
        <div class="glass p-10 text-center max-w-md">
            <div
                class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-5xl shadow-lg shadow-purple-500/30">
                ğŸ“š</div>
            <h1
                class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">
                The Last Turn</h1>
            <p class="text-gray-400 mb-8">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
            <button @click="login()" class="btn btn-primary w-full py-4 text-lg">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
        </div>
    </div>
    <!-- Main App -->
    <div x-show="user&&!loading" x-transition class="min-h-screen">

        <!-- Header -->
        <header class="sticky top-0 z-40 bg-[#0f0f15]/90 backdrop-blur-lg border-b border-white/5">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ“š</span>
                    <span
                        class="font-bold text-xl bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">The
                        Last Turn</span>
                </div>
                <nav class="flex gap-2 flex-wrap">
                    <button @click="tab='dashboard'" :class="tab==='dashboard'?'active':''" class="tab-btn">ğŸ“Š Ù„ÙˆØ­Ø©
                        Ø§Ù„ØªØ­ÙƒÙ…</button>
                    <button x-show="isEnrolled('medicine')" @click="tab='medicine'"
                        :class="tab==='medicine'?'active':''" class="tab-btn">ğŸ«€
                        Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</button>
                    <button x-show="isEnrolled('pediatrics')" @click="tab='pediatrics'"
                        :class="tab==='pediatrics'?'active':''" class="tab-btn">ğŸ‘¶
                        Ø§Ù„Ø£Ø·ÙØ§Ù„</button>
                    <button x-show="false" @click="tab='leaderboard'; fetchLeaderboard()"
                        :class="tab==='leaderboard'?'active':''" class="tab-btn">ğŸ†
                        Ù…Ù†Ø§ÙØ³Ø§ØªÙŠ</button>
                    <button @click="tab='tags'" :class="tab==='tags'?'active':''" class="tab-btn">ğŸ·ï¸
                        Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</button>
                    <button @click="tab='settings'" :class="tab==='settings'?'active':''" class="tab-btn">âš™ï¸</button>
                </nav>
                <div class="flex items-center gap-3">
                    <img :src="user?.photoURL" class="w-10 h-10 rounded-full border-2 border-purple-500"
                        alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <button @click="logout()" class="text-sm text-gray-400 hover:text-white">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">

            <!-- Dashboard -->
            <div x-show="tab==='dashboard'" x-transition>
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">â° Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†</p>
                        <p class="text-4xl font-bold text-purple-400" x-text="daysToExam"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ“… Ø£ÙŠØ§Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                        <p class="text-4xl font-bold text-blue-400" x-text="planDaysRemaining"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                        <p class="text-3xl font-bold text-orange-400" x-text="formatHours(dailyRequired)"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ</p>
                        <p class="text-4xl font-bold text-green-400" x-text="totalProgress+'%'"></p>
                        <div class="progress-bar mt-3">
                            <div class="progress-fill progress-green" :style="'width:'+totalProgress+'%'"></div>
                        </div>
                    </div>
                </div>

                <!-- Hours Cards -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">ğŸ“š Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                        <p class="text-3xl font-bold text-cyan-400" x-text="formatHours(totalHoursNum)"></p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-400 text-sm mb-2">â³ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                        <p class="text-3xl font-bold text-yellow-400" x-text="formatHours(remainingHoursNum)"></p>
                    </div>
                </div>

                <!-- Progress Bars -->
                <div class="grid md:grid-cols-2 gap-4 mb-8">
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-lg">ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</span>
                            <span class="text-purple-400 font-bold" x-text="getProgress('medicine')+'%'"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-purple" :style="'width:'+getProgress('medicine')+'%'">
                            </div>
                        </div>
                        <div class="flex justify-between mt-3 text-sm">
                            <div class="mini-card flex-1 ml-2">
                                <p class="text-gray-500 text-xs">Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                                <p class="text-purple-300 font-bold" x-text="formatHours(getTotalHours('medicine'))">
                                </p>
                            </div>
                            <div class="mini-card flex-1">
                                <p class="text-gray-500 text-xs">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                                <p class="text-purple-300 font-bold"
                                    x-text="formatHours(getRemainingHours('medicine'))"></p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-lg">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„</span>
                            <span class="text-cyan-400 font-bold" x-text="getProgress('pediatrics')+'%'"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill progress-cyan" :style="'width:'+getProgress('pediatrics')+'%'">
                            </div>
                        </div>
                        <div class="flex justify-between mt-3 text-sm">
                            <div class="mini-card flex-1 ml-2">
                                <p class="text-gray-500 text-xs">Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                                <p class="text-cyan-300 font-bold" x-text="formatHours(getTotalHours('pediatrics'))">
                                </p>
                            </div>
                            <div class="mini-card flex-1">
                                <p class="text-gray-500 text-xs">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                                <p class="text-cyan-300 font-bold"
                                    x-text="formatHours(getRemainingHours('pediatrics'))"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivational Card -->
                <!-- On Track / Ahead -->
                <div x-show="delayHours<=0" class="stat-card border-green-500/50 bg-green-500/5 mb-8">
                    <div class="flex items-start gap-4">
                        <span class="text-5xl" x-text="getRandomEmoji('good')">ğŸ‘</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-green-400 mb-2" x-text="getMotivationalTitle('good')">
                                Ø£Ø­Ø³Ù†Øª!</h3>
                            <p class="text-gray-300 mb-3" x-text="getMotivationalQuote('good')"></p>
                            <div class="bg-black/30 rounded-xl p-4">
                                <p class="text-gray-400 text-sm">ØªÙ‚Ø¯Ù…Ùƒ:</p>
                                <p class="text-2xl font-bold text-green-400" x-text="totalProgress+'% Ù…ÙƒØªÙ…Ù„'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Behind Schedule -->
                <div x-show="delayHours>0" class="stat-card border-orange-500/50 bg-orange-500/5 mb-8">
                    <div class="flex items-start gap-4">
                        <span class="text-5xl" x-text="getRandomEmoji('encourage')">ğŸ’ª</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-orange-400 mb-2"
                                x-text="getMotivationalTitle('encourage')">Ù„Ø§ ØªØ³ØªØ³Ù„Ù…!</h3>
                            <p class="text-gray-300 mb-3" x-text="getMotivationalQuote('encourage')"></p>
                            <div class="bg-black/30 rounded-xl p-4 mb-3">
                                <p class="text-gray-400 text-sm">Ù…ØªØ£Ø®Ø± Ø¨Ù€</p>
                                <p class="text-2xl font-bold text-orange-400" x-text="formatHours(delayHours)"></p>
                            </div>
                            <div class="bg-black/30 rounded-xl p-4">
                                <p class="text-gray-400 text-sm">Ù„Ù„ØªØ¹ÙˆÙŠØ¶ØŒ Ø£Ø¶Ù ÙŠÙˆÙ…ÙŠØ§Ù‹:</p>
                                <p class="text-2xl font-bold text-yellow-400" x-text="extraMinutes+' Ø¯Ù‚ÙŠÙ‚Ø©'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Tasks -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Medicine Tasks -->
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-purple-400 text-lg">ğŸ«€ Ù…Ù‡Ø§Ù… Ø§Ù„Ø¨Ø§Ø·Ù†Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
                            <span class="text-sm bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full"
                                x-text="formatMins(getTodayTasksTime('medicine'))"></span>
                        </div>
                        <div x-show="todayTasksComplete('medicine')" class="text-center py-8 text-gray-500">
                            <span class="text-5xl">âœ…</span>
                            <p class="mt-3 text-lg font-bold text-green-400">Ø£Ù†Ø¬Ø²Øª Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…!</p>
                            <p class="text-sm text-gray-500 mt-1">Ø¹Ø¯ ØºØ¯Ø§Ù‹ Ù„Ù„Ù…Ø²ÙŠØ¯</p>
                        </div>
                        <template x-for="task in getFixedTodayTasks('medicine')" :key="task.id">
                            <div class="task-card flex items-center justify-between" x-show="!task.done">
                                <div class="flex-1">
                                    <p class="font-medium text-base" x-text="task.title"></p>
                                    <p class="text-sm text-gray-400" x-text="task.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+task.chapter">
                                    </p>
                                </div>
                                <button @click="markDone(task)"
                                    class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition text-xl">âœ“</button>
                            </div>
                        </template>
                    </div>
                    <!-- Pediatrics Tasks -->
                    <div class="stat-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-cyan-400 text-lg">ğŸ‘¶ Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                            <span class="text-sm bg-cyan-500/20 text-cyan-300 px-3 py-1 rounded-full"
                                x-text="formatMins(getTodayTasksTime('pediatrics'))"></span>
                        </div>
                        <div x-show="todayTasksComplete('pediatrics')" class="text-center py-8 text-gray-500">
                            <span class="text-5xl">âœ…</span>
                            <p class="mt-3 text-lg font-bold text-green-400">Ø£Ù†Ø¬Ø²Øª Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…!</p>
                            <p class="text-sm text-gray-500 mt-1">Ø¹Ø¯ ØºØ¯Ø§Ù‹ Ù„Ù„Ù…Ø²ÙŠØ¯</p>
                        </div>
                        <template x-for="task in getFixedTodayTasks('pediatrics')" :key="task.id">
                            <div class="task-card flex items-center justify-between" x-show="!task.done"
                                style="border-color:rgba(6,182,212,0.2);background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(6,182,212,0.05))">
                                <div class="flex-1">
                                    <p class="font-medium text-base" x-text="task.title"></p>
                                    <p class="text-sm text-gray-400" x-text="task.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+task.chapter">
                                    </p>
                                </div>
                                <button @click="markDone(task)"
                                    class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition text-xl">âœ“</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Subject Views -->
            <template x-for="subj in ['medicine','pediatrics']" :key="subj">
                <div x-show="tab===subj" x-transition>
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold" x-text="subj==='medicine'?'ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„'">
                            </h2>
                            <div class="flex gap-4 mt-2">
                                <div class="mini-card">
                                    <span class="text-gray-500 text-sm">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: </span>
                                    <span class="font-bold"
                                        x-text="getStats(subj).done+'/'+getStats(subj).total"></span>
                                </div>
                                <div class="mini-card">
                                    <span class="text-gray-500 text-sm">Ø§Ù„Ø³Ø§Ø¹Ø§Øª: </span>
                                    <span class="font-bold" x-text="formatHours(getTotalHours(subj))"></span>
                                </div>
                                <div class="mini-card">
                                    <span class="text-gray-500 text-sm">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: </span>
                                    <span class="font-bold" x-text="formatHours(getRemainingHours(subj))"></span>
                                </div>
                            </div>
                        </div>
                        <div class="text-left">
                            <p class="text-4xl font-bold" :class="subj==='medicine'?'text-purple-400':'text-cyan-400'"
                                x-text="getProgress(subj)+'%'"></p>
                            <p class="text-sm text-gray-500">Ù…ÙƒØªÙ…Ù„</p>
                        </div>
                    </div>

                    <p class="text-sm text-gray-500 mb-4">ğŸ’¡ Ø§Ø³Ø­Ø¨ â˜° Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</p>

                    <!-- Chapters List -->
                    <div :id="subj+'-chapters'" class="space-y-5">
                        <template x-for="(ch,ci) in data[subj]" :key="ch.id">
                            <div class="chapter-card" :class="ch.ignored?'ignored':''" :data-id="ch.id">
                                <!-- Chapter Header - Entire area clickable -->
                                <div class="chapter-header" @click="toggleCh(subj,ci)">
                                    <div class="flex items-center gap-4">
                                        <span class="drag-handle text-xl px-3 py-2 bg-gray-700/50 rounded-lg"
                                            @click.stop title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨">â˜°</span>
                                        <span class="text-3xl" x-text="ch.icon">ğŸ“š</span>
                                        <div>
                                            <h3 class="font-bold text-xl" x-text="ch.name"></h3>
                                            <div class="flex gap-2 mt-1">
                                                <span class="text-xs bg-gray-700 px-2 py-1 rounded"
                                                    x-text="getChProg(subj,ci)+'% Ù…ÙƒØªÙ…Ù„'"></span>
                                                <span class="text-xs bg-gray-700 px-2 py-1 rounded"
                                                    x-text="ch.lectures.length+' Ù…Ø­Ø§Ø¶Ø±Ø©'"></span>
                                                <span class="text-xs bg-gray-700 px-2 py-1 rounded"
                                                    x-text="formatHours(getChHrsNum(subj,ci))"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-28 progress-bar hidden sm:block">
                                            <div class="progress-fill"
                                                :class="subj==='medicine'?'progress-purple':'progress-cyan'"
                                                :style="'width:'+getChProg(subj,ci)+'%'"></div>
                                        </div>
                                        <button @click.stop="ch.ignored=!ch.ignored;save()" class="icon-btn"
                                            :class="ch.ignored?'bg-gray-500 text-white':'bg-gray-700/50 text-gray-400'"
                                            title="ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØµÙ„">ğŸ‘</button>
                                        <button @click.stop="deleteChapter(subj,ci)"
                                            class="icon-btn bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"
                                            title="Ø­Ø°Ù Ø§Ù„ÙØµÙ„">ğŸ—‘ï¸</button>
                                        <span class="text-gray-400 text-lg" x-text="openCh[subj+ci]?'â–²':'â–¼'"></span>
                                    </div>
                                </div>
                                <!-- Lectures -->
                                <div x-show="openCh[subj+ci]" x-transition
                                    class="px-5 pb-5 border-t border-white/5 pt-4">
                                    <div :id="'lec-'+ch.id" class="space-y-2">
                                        <template x-for="(lec,li) in ch.lectures" :key="lec.id">
                                            <div class="lecture-row" :class="lec.done?'opacity-50':''"
                                                :data-id="lec.id">
                                                <div class="flex items-center gap-3 flex-1">
                                                    <span
                                                        class="drag-handle text-sm px-2 py-1 bg-gray-700/50 rounded cursor-grab"
                                                        title="Ø§Ø³Ø­Ø¨">â˜°</span>
                                                    <span
                                                        class="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-bold"
                                                        :class="lec.done?'bg-green-500 text-white':'bg-gray-700 text-gray-300'"
                                                        x-text="li+1"></span>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="font-medium text-base"
                                                            :class="lec.done?'line-through text-gray-500':''"
                                                            x-text="lec.title"></p>
                                                        <p class="text-sm text-gray-500" x-text="lec.duration+' Ø¯Ù‚ÙŠÙ‚Ø©'">
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-2 mr-4">
                                                    <button @click="lec.done=!lec.done;save()" class="icon-btn"
                                                        :class="lec.done?'bg-green-500 text-white':'tag-none'"
                                                        title="Ù…ÙƒØªÙ…Ù„">âœ“</button>
                                                    <button @click="cycleTag(lec)" class="icon-btn"
                                                        :class="lec.tag==='review'?'tag-red':lec.tag==='mastered'?'tag-green':'tag-none'"
                                                        :title="lec.tag==='review'?'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©':lec.tag==='mastered'?'Ù…ØªÙ‚Ù†':'Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø©'">
                                                        <span
                                                            x-text="lec.tag==='review'?'ğŸ”´':lec.tag==='mastered'?'ğŸŸ¢':'âšª'"></span>
                                                    </button>
                                                    <button @click="deleteLecture(subj,ci,li)"
                                                        class="icon-btn bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white"
                                                        title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Tags View -->
            <div x-show="tab==='tags'" x-transition>
                <h2 class="text-3xl font-bold mb-6">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</h2>

                <!-- Review Needed (Red) -->
                <div class="stat-card mb-6 border-red-500/30">
                    <h3 class="font-bold text-red-400 text-xl mb-4">ğŸ”´ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© (<span
                            x-text="getTaggedLectures('review').length"></span>)</h3>
                    <div x-show="getTaggedLectures('review').length===0" class="text-center py-6 text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©
                    </div>
                    <template x-for="item in getTaggedLectures('review')" :key="item.id">
                        <div class="lecture-row flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-medium" x-text="item.title"></p>
                                <p class="text-sm text-gray-500"
                                    x-text="item.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+item.chapter+' â€¢ '+(item.subject==='medicine'?'Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'Ø§Ù„Ø£Ø·ÙØ§Ù„')">
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="setTag(item,'mastered')" class="icon-btn tag-green"
                                    title="ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†">ğŸŸ¢</button>
                                <button @click="setTag(item,'none')" class="icon-btn tag-none"
                                    title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©">âšª</button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Mastered (Green) -->
                <div class="stat-card border-green-500/30">
                    <h3 class="font-bold text-green-400 text-xl mb-4">ğŸŸ¢ ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù† (<span
                            x-text="getTaggedLectures('mastered').length"></span>)</h3>
                    <div x-show="getTaggedLectures('mastered').length===0" class="text-center py-6 text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ØªÙ‚Ù†Ø©
                    </div>
                    <template x-for="item in getTaggedLectures('mastered')" :key="item.id">
                        <div class="lecture-row flex items-center justify-between">
                            <div class="flex-1">
                                <p class="font-medium" x-text="item.title"></p>
                                <p class="text-sm text-gray-500"
                                    x-text="item.duration+' Ø¯Ù‚ÙŠÙ‚Ø© â€¢ '+item.chapter+' â€¢ '+(item.subject==='medicine'?'Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'Ø§Ù„Ø£Ø·ÙØ§Ù„')">
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="setTag(item,'review')" class="icon-btn tag-red"
                                    title="ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©">ğŸ”´</button>
                                <button @click="setTag(item,'none')" class="icon-btn tag-none"
                                    title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©">âšª</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Leaderboard Tab: The Race Track -->
            <div x-show="tab==='leaderboard'" x-transition class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center">ğŸ Ù…Ø¶Ù…Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</h2>

                <!-- Loading State -->
                <div x-show="leaderboardLoading" class="text-center py-10">
                    <div
                        class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
                    </div>
                    <p class="text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†...</p>
                </div>

                <div x-show="!leaderboardLoading">
                    <template x-for="subj in ['medicine', 'pediatrics']" :key="subj">
                        <div x-show="isEnrolled(subj)"
                            class="mb-12 bg-[#1a1a24] p-6 rounded-3xl border border-white/5 relative overflow-hidden">
                            <!-- Background Grid Effect -->
                            <div
                                class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20">
                            </div>

                            <h3 class="text-2xl font-bold mb-8 flex items-center gap-2 relative z-10"
                                :class="subj==='medicine'?'text-purple-400':'text-cyan-400'">
                                <span x-text="subj==='medicine'?'ğŸ«€':'ğŸ‘¶'"></span>
                                <span x-text="subj==='medicine'?'Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø£Ø·ÙØ§Ù„'"></span>
                            </h3>

                            <div x-show="!leaderboardData[subj] || leaderboardData[subj].length === 0"
                                class="text-center py-6 text-gray-500 relative z-10">
                                Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† ğŸ˜´
                            </div>

                            <!-- The Track Container -->
                            <div x-show="leaderboardData[subj] && leaderboardData[subj].length > 0"
                                class="relative z-10 mt-10 mb-6 mx-4">

                                <!-- Finish Line (Goal) -->
                                <div class="absolute right-0 -top-8 bottom-0 flex flex-col items-center z-0">
                                    <span class="text-2xl mb-2">ğŸ</span>
                                    <div class="w-0.5 h-full bg-white/20 border-r border-dashed border-white/50">
                                    </div>
                                    <span class="text-xs text-gray-500 mt-2">100%</span>
                                </div>

                                <!-- Start Line -->
                                <div class="absolute left-0 -top-8 bottom-0 flex flex-col items-center z-0">
                                    <span class="text-xs text-gray-500 mb-2">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
                                    <div class="w-0.5 h-full bg-white/10"></div>
                                </div>

                                <!-- The Track Lines -->
                                <div
                                    class="h-0.5 w-[calc(100%-1rem)] bg-white/10 absolute top-1/2 left-2 right-2 -translate-y-1/2 rounded-full">
                                </div>

                                <!-- Racers Area (Height for stacking) -->
                                <div class="relative h-24 w-full" dir="ltr">
                                    <template x-for="(student, index) in leaderboardData[subj]" :key="student.uid">
                                        <!-- Racer Avatar -->
                                        <div class="absolute top-1/2 -translate-y-1/2 transition-all duration-700 ease-out group"
                                            :style="`left: ${Math.min(student.progress, 98)}%; z-index: ${100-index}`">

                                            <!-- Tooltip -->
                                            <!-- Racer Avatar -->
                                            <div class="absolute top-1/2 -translate-y-1/2 transition-all duration-700 ease-out group flex flex-col items-center"
                                                <template x-for="(student, index) in leaderboardData[subj]"
                                                :key="student.uid">
                                                <!-- Racer Avatar -->
                                                <div class="absolute top-1/2 -translate-y-1/2 transition-all duration-700 ease-out group flex flex-col items-center"
                                                    :style="`left: ${Math.min(student.progress, 98)}%; z-index: ${leaderboardData[subj].length + 100 - index}`">

                                                    <!-- Image Ring -->
                                                    <div class="relative transition-transform duration-300 hover:scale-125 hover:z-50"
                                                        :class="{'z-40': student.uid === user.uid}">

                                                        <!-- Status Glow/Border -->
                                                        <div x-show="student.status === 'ahead'"
                                                            class="absolute inset-0 bg-green-500 rounded-full blur-md opacity-40">
                                                        </div>
                                                        <div x-show="student.status === 'behind'"
                                                            class="absolute inset-0 bg-red-500 rounded-full blur-md opacity-20">
                                                        </div>

                                                        <img :src="student.photo || 'https://ui-avatars.com/api/?name='+student.name"
                                                            class="w-12 h-12 rounded-full border-2 object-cover relative z-10 bg-[#0f0f15]"
                                                            :class="{
                                                            'border-green-400': student.status === 'ahead',
                                                            'border-red-400': student.status === 'behind',
                                                            'border-blue-400': student.status === 'on-track' && student.status !== 'behind',
                                                            'border-yellow-400 w-14 h-14 ring-4 ring-yellow-500/30': student.uid === user.uid
                                                        }">

                                                        <!-- 'You' Indicator -->
                                                        <div x-show="student.uid === user.uid"
                                                            class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full whitespace-nowrap z-50 shadow-lg">
                                                            Ø£Ù†Øª
                                                        </div>
                                                    </div>

                                                    <!-- Visible Stats (Name + %) -->
                                                    <div
                                                        class="mt-10 flex flex-col items-center pointer-events-none transform translate-y-1 w-28">
                                                        <span
                                                            class="text-[9px] font-bold text-white bg-black/70 px-2 py-0.5 rounded-full mb-1 truncate max-w-full shadow-sm border border-white/10"
                                                            x-text="student.name.split(' ')[0]"></span>
                                                        <span
                                                            class="text-[9px] font-bold bg-black/40 px-1.5 py-0.5 rounded-md backdrop-blur-sm shadow-sm"
                                                            :class="student.status === 'ahead' ? 'text-green-400' : (student.status === 'behind' ? 'text-red-400' : 'text-blue-400')"
                                                            x-text="student.progress + '%'"></span>
                                                    </div>
                                                </div>
                                    </template>
                                </div>

                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Settings -->
            <div x-show="tab==='settings'" x-transition class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

                <div class="space-y-4">
                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ğŸ“š Ù…ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                        <div class="space-y-2">
                            <button @click="toggleEnrollment('medicine')"
                                class="w-full p-3 rounded-lg border flex items-center justify-between transition"
                                :class="isEnrolled('medicine') ? 'bg-purple-500/20 border-purple-500 text-white' : 'bg-white/5 border-white/10 text-gray-500'">
                                <span>ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø© (Medicine)</span>
                                <span x-text="isEnrolled('medicine') ? 'âœ… Ù…ÙØ¹Ù„' : 'âŒ Ù…Ø®ÙÙŠ'"></span>
                            </button>
                            <button @click="toggleEnrollment('pediatrics')"
                                class="w-full p-3 rounded-lg border flex items-center justify-between transition"
                                :class="isEnrolled('pediatrics') ? 'bg-cyan-500/20 border-cyan-500 text-white' : 'bg-white/5 border-white/10 text-gray-500'">
                                <span>ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„ (Pediatrics)</span>
                                <span x-text="isEnrolled('pediatrics') ? 'âœ… Ù…ÙØ¹Ù„' : 'âŒ Ù…Ø®ÙÙŠ'"></span>
                            </button>
                        </div>
                    </div>

                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label>
                        <input type="date" x-model="settings.examDate" @change="save()">
                    </div>
                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ï¿½ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø®Ø·Ø©</label>
                        <input type="date" x-model="settings.planStartDate" @change="save()">
                        <p class="text-xs text-gray-500 mt-2">ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ±</p>
                    </div>
                    <div class="stat-card">
                        <label class="block text-gray-400 mb-2">ğŸ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©</label>
                        <input type="date" x-model="settings.planEndDate" @change="save()">
                        <p class="text-xs text-gray-500 mt-2">ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                    </div>

                    <!-- Smart Parser -->
                    <div class="stat-card border-purple-500/30">
                        <h3 class="font-bold text-purple-400 mb-4 text-lg">ğŸ“¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h3>

                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                                <select x-model="parser.subject" @change="parser.chapter=''">
                                    <option value="medicine">ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</option>
                                    <option value="pediatrics">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ø®ØªØ± ÙØµÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙŠØ¯</label>
                                <select x-model="parser.chapter">
                                    <option value="">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯...</option>
                                    <template x-for="ch in data[parser.subject]" :key="ch.id">
                                        <option :value="ch.id" x-text="ch.icon+' '+ch.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div x-show="parser.chapter===''">
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                                <input type="text" x-model="parser.newName" placeholder="Ù…Ø«Ù„: Cardiology">
                            </div>
                            <div x-show="parser.chapter===''">
                                <label class="text-sm text-gray-500 mb-1 block">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØµÙ„</label>
                                <input type="text" x-model="parser.newIcon" placeholder="Ù…Ø«Ù„: â¤ï¸">
                            </div>

                            <div>
                                <label class="text-sm text-gray-500 mb-1 block">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª (ÙƒÙ„ Ø³Ø·Ø±: Ø§Ø³Ù… -
                                    Ù…Ø¯Ø©)</label>
                                <textarea x-model="parser.text" rows="5" placeholder="Lecture 1 - 30
Lecture 2 - 45
Lecture 3 - 60"></textarea>
                            </div>

                            <button @click="parseAndAdd()" class="btn btn-primary w-full py-3">â• Ø¥Ø¶Ø§ÙØ©
                                Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
                        </div>
                    </div>

                    <!-- Admin Only: Publish Courses -->
                    <div x-show="isAdmin" class="stat-card border-purple-500/30 bg-purple-500/10">
                        <h3 class="font-bold text-purple-400 mb-3 text-lg">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
                        <button @click="publishCourses()"
                            class="w-full py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition">
                            ğŸ“¤ Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø©
                        </button>
                        <p class="text-sm text-gray-400 mt-2">Ø§Ù†Ù‚Ø± Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="stat-card border-yellow-500/30">
                        <button @click="forceReload()" class="text-yellow-400 font-bold">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                        <p class="text-sm text-gray-500 mt-1">Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙØ§Ø±ØºØ©</p>
                    </div>
                    <div class="stat-card border-red-500/30">
                        <button @click="resetAll()" class="text-red-400 font-bold">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const DEFAULT_DATA = {
            medicine: [],
            pediatrics: []
        };

        function app() {
            return {
                loading: true,
                user: null,
                tab: 'dashboard',
                unsub: null,
                openCh: {},
                settings: { examDate: '2026-04-15', planEndDate: '2026-04-01', planStartDate: '2026-02-03' },
                parser: { subject: 'medicine', chapter: '', newName: '', newIcon: 'ğŸ“š', text: '' },
                data: { medicine: [], pediatrics: [] },
                todayCache: { date: '', medicine: [], pediatrics: [] },
                leaderboardData: { medicine: [], pediatrics: [] },
                leaderboardLoading: false,
                enrolledCourses: [], // 'medicine', 'pediatrics'
                showEnrollModal: false,

                isEnrolled(subj) {
                    return this.enrolledCourses.includes(subj);
                },

                toggleEnrollment(subj) {
                    if (this.enrolledCourses.includes(subj)) {
                        this.enrolledCourses = this.enrolledCourses.filter(c => c !== subj);
                    } else {
                        this.enrolledCourses.push(subj);
                    }
                    this.save();
                },

                subscribeToLeaderboard() {
                    const self = this;
                    ['medicine', 'pediatrics'].forEach(subj => {
                        const ref = window.fb.collection(window.fb.db, 'leaderboard', subj, 'students');
                        window.fb.onSnapshot(ref, (snap) => {
                            const students = [];
                            snap.forEach(doc => students.push(doc.data()));
                            // Sort by progress descending
                            self.leaderboardData[subj] = students.sort((a, b) => b.progress - a.progress);
                        }, (error) => {
                            console.error("Error listening to leaderboard:", error);
                        });
                    });
                },

                async init() {
                    const setup = () => {
                        window.fb.onAuthStateChanged(window.fb.auth, async (u) => {
                            this.user = u;
                            if (u) {
                                this.subscribeToLeaderboard();
                                await this.load();
                            }
                            this.loading = false;
                            this.$nextTick(() => this.initSortable());
                        });
                    };
                    if (window.fb) setup();
                    else window.addEventListener('fb-ready', setup);
                },

                async login() {
                    try { await window.fb.signInWithPopup(window.fb.auth, window.fb.provider); }
                    catch (e) { alert('Ø®Ø·Ø£: ' + e.message); }
                },

                async logout() {
                    if (this.unsub) this.unsub();
                    await window.fb.signOut(window.fb.auth);
                    this.user = null;
                },

                async load() {
                    try {
                        // 1. Load shared courses (ALWAYS)
                        const coursesData = { medicine: [], pediatrics: [] };

                        try {
                            for (const subject of ['medicine', 'pediatrics']) {
                                const courseRef = window.fb.doc(window.fb.db, 'courses', subject);
                                const courseDoc = await window.fb.getDoc(courseRef);

                                if (courseDoc.exists()) {
                                    coursesData[subject] = courseDoc.data().chapters || [];
                                }
                            }
                        } catch (e) {
                            console.error("Error fetching courses:", e);
                        }

                        // 2. Load user data
                        const userRef = window.fb.doc(window.fb.db, 'users', this.user.uid);
                        this.unsub = window.fb.onSnapshot(userRef, (userDoc) => {
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                const hasOldData = userData.data && (userData.data.medicine?.length > 0 || userData.data.pediatrics?.length > 0);
                                const coursesEmpty = coursesData.medicine.length === 0 && coursesData.pediatrics.length === 0;

                                if (coursesEmpty && hasOldData) {
                                    // Fallback: Use old local data if shared courses aren't available
                                    this.data = userData.data;
                                } else {
                                    // STANDARD: Use Shared Courses + User Progress
                                    for (const subject of ['medicine', 'pediatrics']) {
                                        // Start with fresh copy of shared course
                                        this.data[subject] = JSON.parse(JSON.stringify(coursesData[subject]));

                                        // Apply user progress
                                        const userProgress = userData.progress?.[subject] || {};

                                        this.data[subject].forEach(chapter => {
                                            chapter.lectures?.forEach(lecture => {
                                                const lectureProgress = userProgress[lecture.id];
                                                if (lectureProgress) {
                                                    lecture.done = lectureProgress.done || false;
                                                    lecture.tag = lectureProgress.tag || 'none';
                                                }
                                            });
                                        });
                                    }
                                }

                                // Load settings
                                if (userData.settings) this.settings = { ...this.settings, ...userData.settings };
                                if (userData.todayCache) this.todayCache = userData.todayCache;

                                // Load Enrollment
                                this.enrolledCourses = userData.enrolledCourses || ['medicine', 'pediatrics'];

                            } else {
                                // New User: Use courses data directly
                                this.data = JSON.parse(JSON.stringify(coursesData));
                                this.enrolledCourses = ['medicine', 'pediatrics'];
                                this.save();
                            }

                            this.refreshTodayTasks();
                            this.$nextTick(() => this.initSortable());
                        });

                    } catch (e) {
                        console.error('Error loading data:', e);
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message);
                    }
                },

                async save() {
                    if (!this.user) return;

                    // Extract only user-specific progress
                    const progress = { medicine: {}, pediatrics: {} };

                    for (const subject of ['medicine', 'pediatrics']) {
                        this.data[subject]?.forEach(chapter => {
                            chapter.lectures?.forEach(lecture => {
                                if (lecture.done || lecture.tag !== 'none') {
                                    progress[subject][lecture.id] = {
                                        done: lecture.done || false,
                                        tag: lecture.tag || 'none'
                                    };
                                }
                            });
                        });
                    }

                    await window.fb.setDoc(window.fb.doc(window.fb.db, 'users', this.user.uid), {
                        progress: progress,
                        settings: this.settings,
                        todayCache: this.todayCache,
                        enrolledCourses: this.enrolledCourses,
                        profile: {
                            name: this.user.displayName,
                            photo: this.user.photoURL,
                            email: this.user.email
                        }
                    }, { merge: true });

                    // Publish to Shared Leaderboard
                    ['medicine', 'pediatrics'].forEach(async (subj) => {
                        const prog = this.getProgress(subj);

                        // Calculate Status (simple logic for now)
                        let status = 'on-track';
                        // You can enhance logic here if needed

                        const statsRef = window.fb.doc(window.fb.db, 'leaderboard', subj, 'students', this.user.uid);
                        await window.fb.setDoc(statsRef, {
                            name: this.user.displayName,
                            photo: this.user.photoURL,
                            uid: this.user.uid,
                            progress: prog,
                            status: this.delayHours > 0 ? 'behind' : 'ahead', // Simple status based on delay
                            lastUpdate: new Date().toISOString()
                        });
                    });
                },

                // Format helpers
                formatHours(hrs) {
                    const h = Math.floor(hrs);
                    const m = Math.round((hrs - h) * 60);
                    if (h === 0) return m + ' Ø¯Ù‚ÙŠÙ‚Ø©';
                    if (m === 0) return h + ' Ø³Ø§Ø¹Ø©';
                    return h + ' Ø³Ø§Ø¹Ø© Ùˆ ' + m + ' Ø¯Ù‚ÙŠÙ‚Ø©';
                },

                formatMins(mins) {
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    if (h === 0) return m + ' Ø¯Ù‚ÙŠÙ‚Ø©';
                    if (m === 0) return h + ' Ø³Ø§Ø¹Ø©';
                    return h + ' Ø³Ø§Ø¹Ø© Ùˆ ' + m + ' Ø¯Ù‚ÙŠÙ‚Ø©';
                },

                initSortable() {
                    const self = this;
                    ['medicine', 'pediatrics'].forEach(subj => {
                        const el = document.getElementById(subj + '-chapters');
                        if (el && !el._sortable) {
                            el._sortable = new Sortable(el, {
                                handle: '.drag-handle',
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                onEnd: () => {
                                    const items = [...el.querySelectorAll('[data-id]')].map(e => e.dataset.id);
                                    const newOrder = items.map(id => self.data[subj].find(ch => ch.id === id)).filter(Boolean);
                                    self.data[subj] = newOrder;
                                    self.save();
                                }
                            });
                        }
                    });
                    ['medicine', 'pediatrics'].forEach(subj => {
                        this.data[subj]?.forEach((ch) => {
                            const el = document.getElementById('lec-' + ch.id);
                            if (el && !el._sortable) {
                                el._sortable = new Sortable(el, {
                                    handle: '.drag-handle',
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    onEnd: () => {
                                        const items = [...el.querySelectorAll('[data-id]')].map(e => e.dataset.id);
                                        const newOrder = items.map(id => ch.lectures.find(l => l.id === id)).filter(Boolean);
                                        ch.lectures = newOrder;
                                        self.save();
                                    }
                                });
                            }
                        });
                    });
                },

                toggleCh(subj, i) {
                    this.openCh[subj + i] = !this.openCh[subj + i];
                    this.$nextTick(() => this.initSortable());
                },

                deleteChapter(subj, ci) {
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙ‡ØŸ')) {
                        this.data[subj].splice(ci, 1);
                        this.save();
                    }
                },

                deleteLecture(subj, ci, li) {
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©ØŸ')) {
                        this.data[subj][ci].lectures.splice(li, 1);
                        this.save();
                    }
                },

                // Tags
                cycleTag(lec) {
                    if (!lec.tag || lec.tag === 'none') lec.tag = 'review';
                    else if (lec.tag === 'review') lec.tag = 'mastered';
                    else lec.tag = 'none';
                    this.save();
                },

                setTag(item, tag) {
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s] || []) {
                            for (const l of ch.lectures || []) {
                                if (l.id === item.id) { l.tag = tag; this.save(); return; }
                            }
                        }
                    }
                },

                getTaggedLectures(tag) {
                    const list = [];
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s] || []) {
                            for (const l of ch.lectures || []) {
                                if (l.tag === tag) {
                                    list.push({ ...l, subject: s, chapter: ch.name });
                                }
                            }
                        }
                    }
                    return list;
                },

                // Calculations
                get daysToExam() { return Math.max(0, Math.ceil((new Date(this.settings.examDate) - new Date()) / 86400000)); },
                get planDaysRemaining() { return Math.max(1, Math.ceil((new Date(this.settings.planEndDate) - new Date()) / 86400000)); },
                get planDaysPassed() {
                    const start = new Date(this.settings.planStartDate);
                    const now = new Date();
                    const passed = Math.floor((now - start) / 86400000);
                    return Math.max(0, passed);
                },
                get totalPlanDays() {
                    const start = new Date(this.settings.planStartDate);
                    const end = new Date(this.settings.planEndDate);
                    return Math.max(1, Math.ceil((end - start) / 86400000));
                },

                getTotalHours(subj) {
                    let t = 0;
                    this.data[subj]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => t += l.duration); });
                    return t / 60;
                },

                getRemainingHours(subj) {
                    let t = 0;
                    this.data[subj]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => { if (!l.done) t += l.duration; }); });
                    return t / 60;
                },

                getDailyRequired(subj) {
                    const remaining = this.getRemainingHours(subj);
                    return remaining / this.planDaysRemaining;
                },

                get dailyRequired() {
                    return this.getDailyRequired('medicine') + this.getDailyRequired('pediatrics');
                },

                get totalHoursNum() {
                    return this.getTotalHours('medicine') + this.getTotalHours('pediatrics');
                },

                get remainingHoursNum() {
                    return this.getRemainingHours('medicine') + this.getRemainingHours('pediatrics');
                },

                get totalProgress() {
                    const t = this.totalHoursNum, d = t - this.remainingHoursNum;
                    return t > 0 ? Math.round(d / t * 100) : 0;
                },

                getProgress(subj) {
                    let t = 0, d = 0;
                    this.data[subj]?.forEach(c => { if (!c.ignored) c.lectures?.forEach(l => { t++; if (l.done) d++; }); });
                    return t > 0 ? Math.round(d / t * 100) : 0;
                },
                getStats(subj) {
                    let t = 0, d = 0;
                    this.data[subj]?.forEach(c => c.lectures?.forEach(l => { t++; if (l.done) d++; }));
                    return { total: t, done: d };
                },
                getChProg(subj, i) {
                    const ch = this.data[subj]?.[i];
                    if (!ch || !ch.lectures?.length) return 0;
                    return Math.round(ch.lectures.filter(l => l.done).length / ch.lectures.length * 100);
                },
                getChHrsNum(subj, i) {
                    const ch = this.data[subj]?.[i];
                    if (!ch) return 0;
                    return ch.lectures?.reduce((a, l) => a + l.duration, 0) / 60;
                },

                get expectedHours() {
                    // Expected = (total hours / total plan days) * days passed since start
                    if (this.totalPlanDays <= 0 || this.planDaysPassed <= 0) return 0;
                    return (this.totalHoursNum / this.totalPlanDays) * this.planDaysPassed;
                },
                get delayHours() {
                    const done = this.totalHoursNum - this.remainingHoursNum;
                    return Math.max(0, this.expectedHours - done);
                },
                get extraMinutes() { return this.planDaysRemaining > 0 ? Math.round(this.delayHours * 60 / this.planDaysRemaining) : 0; },

                // Motivational Messages
                getRandomEmoji(type) {
                    const emojis = type === 'good'
                        ? ['ğŸ‘', 'ğŸ‰', 'â­', 'ğŸ†', 'ğŸ”¥', 'ğŸ’¯', 'ğŸš€', 'âœ¨', 'ğŸ‘‘', 'ğŸ’ª']
                        : ['ğŸ’ª', 'ğŸŒŸ', 'ğŸ¯', 'âš¡', 'ğŸ¦', 'ğŸ”±', 'ğŸ’', 'ğŸŒˆ', 'ğŸ“', 'â°'];
                    return emojis[Math.floor(Math.random() * emojis.length)];
                },

                getMotivationalTitle(type) {
                    const titles = type === 'good'
                        ? ['Ø£Ø­Ø³Ù†Øª! Ø£Ù†Øª Ù…Ù„ØªØ²Ù… Ø¨Ø§Ù„Ø®Ø·Ø©', 'Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± Ù‡ÙƒØ°Ø§', 'Ù…Ù…ØªØ§Ø²! Ø£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­', 'Ø¨Ø·Ù„! ØªÙ‚Ø¯Ù…Ùƒ Ù…Ø°Ù‡Ù„', 'Ù…Ø¨Ø¯Ø¹! Ø®Ø·ØªÙƒ Ù†Ø§Ø¬Ø­Ø©']
                        : ['Ù„Ø§ ØªØ³ØªØ³Ù„Ù…!', 'Ø£Ù†Øª Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹ÙˆÙŠØ¶', 'ÙƒÙ„ ØªØ£Ø®ÙŠØ± ÙŠÙØ¹ÙˆÙÙ‘Ø¶', 'Ø§Ù„Ù†Ø¬Ø§Ø­ ÙŠØ­ØªØ§Ø¬ ØµØ¨Ø±Ø§Ù‹', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!'];
                    return titles[Math.floor(Math.random() * titles.length)];
                },

                getMotivationalQuote(type) {
                    const quotes = type === 'good'
                        ? [
                            'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù‡Ùˆ Ø³Ø± Ø§Ù„Ù†Ø¬Ø§Ø­. Ø§Ø³ØªÙ…Ø±!',
                            'ÙƒÙ„ Ù…Ø­Ø§Ø¶Ø±Ø© ØªÙÙ†Ù‡ÙŠÙ‡Ø§ Ù‡ÙŠ Ø®Ø·ÙˆØ© Ù†Ø­Ùˆ Ø­Ù„Ù…Ùƒ.',
                            'Ø£Ù†Øª ØªØµÙ†Ø¹ Ù…Ø³ØªÙ‚Ø¨Ù„Ùƒ Ø¨ÙƒÙ„ Ù„Ø­Ø¸Ø© ØªÙ‚Ø¶ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø©.',
                            'Ø§Ù„ØªÙ…ÙŠØ² Ù„ÙŠØ³ ØµØ¯ÙØ©ØŒ Ø¨Ù„ Ù†ØªÙŠØ¬Ø© Ø¬Ù‡Ø¯ Ù…ØªÙˆØ§ØµÙ„.',
                            'Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù†Ø§Ø¬Ø­ ÙŠØ¨Ø¯Ø£ Ø¨Ø·Ø§Ù„Ø¨ Ù…Ù„ØªØ²Ù….',
                            'ÙƒÙ„ Ø³Ø§Ø¹Ø© ØªØ³ØªØ«Ù…Ø±Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ… Ø³ØªÙÙƒØ§ÙØ£ ØºØ¯Ø§Ù‹.',
                            'Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­ØŒ Ù„Ø§ ØªØªÙˆÙ‚Ù!'
                        ]
                        : [
                            'Ù„ÙŠØ³ Ø§Ù„Ù…Ù‡Ù… Ø£Ù† ØªØ³Ù‚Ø·ØŒ Ø¨Ù„ Ø£Ù† ØªÙ†Ù‡Ø¶.',
                            'ÙƒÙ„ ÙŠÙˆÙ… ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.',
                            'Ø§Ù„ØªØ£Ø®ÙŠØ± Ù„ÙŠØ³ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ØŒ Ø§Ù„ØªÙˆÙ‚Ù Ù‡Ùˆ.',
                            'Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù„Ù Ù…ÙŠÙ„ ÙŠØ¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ©.',
                            'Ù„Ø§ ØªÙ‚Ø§Ø±Ù† Ù†ÙØ³Ùƒ Ø¨Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ Ù‚Ø§Ø±Ù†Ù‡Ø§ Ø¨Ù†ÙØ³Ùƒ Ø£Ù…Ø³.',
                            'Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„ÙŠØ³ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§Ù„ÙØ´Ù„ Ù„ÙŠØ³ Ù‚Ø§ØªÙ„Ø§Ù‹.',
                            'Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø­ÙŠØ« Ø£Ù†ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ù„Ø¯ÙŠÙƒ.',
                            'Ø§Ù„Ø¹Ø¸Ù…Ø§Ø¡ Ù„Ø§ ÙŠØ³ØªØ³Ù„Ù…ÙˆÙ† Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¹Ù‚Ø¨Ø©.'
                        ];
                    return quotes[Math.floor(Math.random() * quotes.length)];
                },

                // Daily Tasks - Fixed per day
                getToday() {
                    return new Date().toISOString().split('T')[0];
                },

                refreshTodayTasks() {
                    const today = this.getToday();
                    if (this.todayCache.date !== today) {
                        // New day - recalculate tasks
                        this.todayCache = {
                            date: today,
                            medicine: this.calculateTodayTasks('medicine'),
                            pediatrics: this.calculateTodayTasks('pediatrics')
                        };
                        this.save();
                    }
                },

                calculateTodayTasks(subj) {
                    const taskIds = [];
                    let totalMins = 0;
                    const targetMins = this.getDailyRequired(subj) * 60;

                    for (const ch of (this.data[subj] || [])) {
                        if (ch.ignored) continue;
                        for (const l of (ch.lectures || [])) {
                            if (l.done) continue;

                            // Always add at least one if we have none
                            if (taskIds.length === 0) {
                                taskIds.push(l.id);
                                totalMins += l.duration;
                                continue;
                            }

                            // If adding this gets us closer to target, add it
                            if (totalMins < targetMins) {
                                taskIds.push(l.id);
                                totalMins += l.duration;
                            } else {
                                // We're at or over target - check if we should add one more
                                const withoutThis = Math.abs(totalMins - targetMins);
                                const withThis = Math.abs(totalMins + l.duration - targetMins);
                                if (withThis < withoutThis) {
                                    // Adding this gets us closer - add it (lean towards more)
                                    taskIds.push(l.id);
                                    totalMins += l.duration;
                                }
                                break;
                            }
                        }
                        if (totalMins >= targetMins) break;
                    }
                    return taskIds;
                },

                getFixedTodayTasks(subj) {
                    const ids = this.todayCache[subj] || [];
                    const tasks = [];
                    for (const ch of (this.data[subj] || [])) {
                        for (const l of (ch.lectures || [])) {
                            if (ids.includes(l.id)) {
                                tasks.push({ ...l, chapter: ch.name });
                            }
                        }
                    }
                    return tasks;
                },

                getTodayTasksTime(subj) {
                    return this.getFixedTodayTasks(subj).reduce((a, t) => a + t.duration, 0);
                },

                todayTasksComplete(subj) {
                    const tasks = this.getFixedTodayTasks(subj);
                    return tasks.length > 0 && tasks.every(t => t.done);
                },

                markDone(task) {
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of (this.data[s] || [])) {
                            for (const l of (ch.lectures || [])) {
                                if (l.id === task.id) { l.done = true; this.save(); return; }
                            }
                        }
                    }
                },

                // Admin Functions
                get isAdmin() {
                    return this.user?.email === 'dr.aliahmed089@gmail.com';
                },

                async migrateDataToCourses() {
                    if (!this.isAdmin) {
                        alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·');
                        return;
                    }

                    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©ØŸ\nØ³ÙŠØ±Ø§Ù‡Ø§ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø©')) return;

                    try {
                        for (const subject of ['medicine', 'pediatrics']) {
                            // Clean data: remove user-specific fields
                            const cleanChapters = JSON.parse(JSON.stringify(this.data[subject]));
                            cleanChapters.forEach(ch => {
                                ch.lectures?.forEach(l => {
                                    delete l.done;
                                    l.tag = 'none';
                                });
                            });

                            await window.fb.setDoc(
                                window.fb.doc(window.fb.db, 'courses', subject),
                                { chapters: cleanChapters },
                                { merge: true }
                            );
                        }
                        alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ø¢Ù† Ø³ÙŠØ±Ø§Ù‡Ø§ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø©.');
                    } catch (e) {
                        alert('Ø®Ø·Ø£: ' + e.message);
                    }
                },

                async publishCourses() {
                    if (!this.isAdmin) return;
                    await this.migrateDataToCourses();
                },

                forceReload() {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©. Ø£Ø¶Ù Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
                },

                resetAll() {
                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                        this.data = { medicine: [], pediatrics: [] };
                        this.todayCache = { date: '', medicine: [], pediatrics: [] };
                        this.save();
                    }
                },

                parseAndAdd() {
                    if (!this.parser.text.trim()) {
                        alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª');
                        return;
                    }

                    const lines = this.parser.text.trim().split('\n');
                    const newLectures = lines.map((line, i) => {
                        const parts = line.split('-');
                        return {
                            id: 'lec_' + Date.now() + '_' + i,
                            title: parts[0]?.trim() || 'Ù…Ø­Ø§Ø¶Ø±Ø©',
                            duration: parseInt(parts[1]) || 30,
                            done: false,
                            tag: 'none'
                        };
                    });

                    if (this.parser.chapter) {
                        const ch = this.data[this.parser.subject].find(c => c.id === this.parser.chapter);
                        if (ch) {
                            ch.lectures.push(...newLectures);
                            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + newLectures.length + ' Ù…Ø­Ø§Ø¶Ø±Ø© Ø¥Ù„Ù‰ ' + ch.name);
                        }
                    } else {
                        if (!this.parser.newName) {
                            alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
                            return;
                        }
                        const newChapter = {
                            id: 'ch_' + Date.now(),
                            name: this.parser.newName,
                            icon: this.parser.newIcon || 'ğŸ“š',
                            ignored: false,
                            lectures: newLectures
                        };
                        this.data[this.parser.subject].push(newChapter);
                        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯: ' + this.parser.newName + ' (' + newLectures.length + ' Ù…Ø­Ø§Ø¶Ø±Ø©)');
                    }

                    this.parser = { subject: this.parser.subject, chapter: '', newName: '', newIcon: 'ğŸ“š', text: '' };
                    this.refreshTodayTasks();
                    this.save();
                    this.$nextTick(() => this.initSortable());
                }
            };
        }
    </script>
</body>

</html>