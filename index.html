<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Last Turn</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        const app = initializeApp({ apiKey: "AIzaSyBpMhO7a6p4ktKjoEta1MOTSLF345eIsRQ", authDomain: "the-last-turn.firebaseapp.com", projectId: "the-last-turn", storageBucket: "the-last-turn.firebasestorage.app", messagingSenderId: "747668413856", appId: "1:747668413856:web:6c67a8b56e7bdec53d58c5" });
        window.fb = { auth: getAuth(app), db: getFirestore(app), provider: new GoogleAuthProvider(), signInWithPopup, onAuthStateChanged, signOut, doc, setDoc, onSnapshot };
        window.dispatchEvent(new Event('fb-ready'));
    </script>
    <style>
        * {
            font-family: 'Tajawal', sans-serif
        }

        body {
            background: linear-gradient(135deg, #0a0a0f, #12121a);
            min-height: 100vh
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1)
        }

        .gradient-text {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .progress-purple {
            background: linear-gradient(90deg, #8b5cf6, #a855f7)
        }

        .progress-cyan {
            background: linear-gradient(90deg, #06b6d4, #22d3ee)
        }

        .acc-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s
        }

        .acc-content.open {
            max-height: 5000px
        }

        .dimmed {
            opacity: 0.4
        }
    </style>
</head>

<body class="text-white" x-data="app()" x-init="init()">

    <!-- Loading -->
    <div x-show="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0a0a0f]">
        <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- Login -->
    <div x-show="!user&&!loading" class="fixed inset-0 z-40 flex items-center justify-center p-4">
        <div class="glass rounded-3xl p-10 text-center max-w-md">
            <div
                class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-500 to-cyan-500 flex items-center justify-center text-3xl">
                ğŸ“š</div>
            <h1 class="text-3xl font-bold mb-2 gradient-text">The Last Turn</h1>
            <p class="text-gray-400 mb-8">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</p>
            <button @click="login()"
                class="w-full py-4 bg-white text-gray-800 rounded-xl font-bold hover:bg-gray-100">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€
                Google</button>
        </div>
    </div>

    <!-- Main -->
    <div x-show="user&&!loading" class="min-h-screen">
        <!-- Header -->
        <header class="glass sticky top-0 z-30">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <span class="font-bold gradient-text text-xl">ğŸ“š The Last Turn</span>
                <nav class="flex gap-1 bg-[#1a1a25] rounded-lg p-1">
                    <button @click="tab='dashboard'" :class="tab==='dashboard'?'bg-purple-500/20':''"
                        class="px-3 py-2 rounded text-sm">ğŸ“Š</button>
                    <button @click="tab='medicine'" :class="tab==='medicine'?'bg-purple-500/20':''"
                        class="px-3 py-2 rounded text-sm">ğŸ«€</button>
                    <button @click="tab='pediatrics'" :class="tab==='pediatrics'?'bg-purple-500/20':''"
                        class="px-3 py-2 rounded text-sm">ğŸ‘¶</button>
                    <button @click="tab='settings'" :class="tab==='settings'?'bg-purple-500/20':''"
                        class="px-3 py-2 rounded text-sm">âš™ï¸</button>
                </nav>
                <div class="flex items-center gap-2">
                    <img :src="user?.photoURL" class="w-8 h-8 rounded-full">
                    <button @click="logout()" class="text-xs text-gray-400">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">

            <!-- Dashboard -->
            <div x-show="tab==='dashboard'">
                <!-- Stats Row 1 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-2xl p-5">
                        <p class="text-gray-400 text-sm">Ø£ÙŠØ§Ù… Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†</p>
                        <p class="text-4xl font-bold text-purple-400" x-text="daysToExam"></p>
                    </div>
                    <div class="glass rounded-2xl p-5">
                        <p class="text-gray-400 text-sm">Ø£ÙŠØ§Ù… Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                        <p class="text-4xl font-bold text-cyan-400" x-text="daysInPlan"></p>
                    </div>
                    <div class="glass rounded-2xl p-5">
                        <p class="text-gray-400 text-sm">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</p>
                        <p class="text-2xl font-bold"><span class="text-green-400" x-text="hoursDone"></span> / <span
                                class="text-gray-400" x-text="totalHours"></span></p>
                    </div>
                    <div class="glass rounded-2xl p-5"
                        :class="status==='behind'?'border border-red-500':'border border-green-500'">
                        <p class="text-gray-400 text-sm">Ø§Ù„Ø­Ø§Ù„Ø©</p>
                        <p class="text-xl font-bold" :class="status==='behind'?'text-red-400':'text-green-400'"
                            x-text="status==='behind'?'Ù…ØªØ£Ø®Ø± âŒ':'Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± âœ…'"></p>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-lg">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ</span>
                        <span class="text-2xl font-bold gradient-text" x-text="totalProgress+'%'"></span>
                    </div>
                    <div class="h-4 bg-gray-700 rounded-full mb-4">
                        <div class="h-full progress-purple rounded-full" :style="'width:'+totalProgress+'%'"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1"><span>ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©</span><span
                                    class="text-purple-400" x-text="getMedProgress()+'%'"></span></div>
                            <div class="h-2 bg-gray-700 rounded-full">
                                <div class="h-full progress-purple rounded-full" :style="'width:'+getMedProgress()+'%'">
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1"><span>ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„</span><span
                                    class="text-cyan-400" x-text="getPedProgress()+'%'"></span></div>
                            <div class="h-2 bg-gray-700 rounded-full">
                                <div class="h-full progress-cyan rounded-full" :style="'width:'+getPedProgress()+'%'">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Catch-up Alert -->
                <div x-show="delayHours>0" class="glass rounded-2xl p-6 mb-6 border border-red-500 bg-red-500/10">
                    <div class="flex gap-4">
                        <span class="text-4xl">âš ï¸</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-red-400 mb-2">Ø£Ù†Øª Ù…ØªØ£Ø®Ø±!</h3>
                            <p class="mb-2">Ù…ØªØ£Ø®Ø± Ø¨Ù€ <span class="font-bold text-red-400"
                                    x-text="delayHours.toFixed(1)"></span> Ø³Ø§Ø¹Ø©</p>
                            <div class="bg-gray-800 rounded-xl p-4">
                                <p class="text-sm text-gray-400">Ù„Ù„ØªØ¹ÙˆÙŠØ¶ØŒ Ø£Ø¶Ù ÙŠÙˆÙ…ÙŠØ§Ù‹:</p>
                                <p class="text-3xl font-bold text-orange-400" x-text="extraMinutes+' Ø¯Ù‚ÙŠÙ‚Ø©'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today Tasks Split -->
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Medicine Tasks -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-bold text-purple-400 mb-4">ğŸ«€ Ù…Ù‡Ø§Ù… Ø§Ù„Ø¨Ø§Ø·Ù†Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div class="space-y-2">
                            <template x-for="t in getTodayTasks('medicine')" :key="t.id">
                                <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
                                    <div>
                                        <p class="font-medium text-sm" x-text="t.title"></p>
                                        <p class="text-xs text-gray-500" x-text="t.duration+' Ø¯ â€¢ '+t.chapter"></p>
                                    </div>
                                    <button @click="markDone(t)"
                                        class="w-8 h-8 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white">âœ“</button>
                                </div>
                            </template>
                            <p x-show="getTodayTasks('medicine').length===0" class="text-gray-500 text-center py-4">âœ… Ù„Ø§
                                ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</p>
                        </div>
                    </div>
                    <!-- Pediatrics Tasks -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-bold text-cyan-400 mb-4">ğŸ‘¶ Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div class="space-y-2">
                            <template x-for="t in getTodayTasks('pediatrics')" :key="t.id">
                                <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
                                    <div>
                                        <p class="font-medium text-sm" x-text="t.title"></p>
                                        <p class="text-xs text-gray-500" x-text="t.duration+' Ø¯ â€¢ '+t.chapter"></p>
                                    </div>
                                    <button @click="markDone(t)"
                                        class="w-8 h-8 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white">âœ“</button>
                                </div>
                            </template>
                            <p x-show="getTodayTasks('pediatrics').length===0" class="text-gray-500 text-center py-4">âœ…
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</p>
                        </div>
                    </div>
                </div>

                <!-- Catch-up Tasks -->
                <div x-show="delayHours>0" class="glass rounded-2xl p-5 border border-orange-500/50">
                    <h3 class="font-bold text-orange-400 mb-4">ğŸ”¥ Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                    <div class="space-y-2">
                        <template x-for="t in catchupTasks" :key="t.id">
                            <div class="flex items-center justify-between bg-orange-500/10 rounded-lg p-3">
                                <div>
                                    <p class="font-medium text-sm" x-text="t.title"></p>
                                    <p class="text-xs text-gray-500"
                                        x-text="t.duration+' Ø¯ â€¢ '+t.chapter+' â€¢ '+(t.subject==='medicine'?'Ø¨Ø§Ø·Ù†Ø©':'Ø£Ø·ÙØ§Ù„')">
                                    </p>
                                </div>
                                <button @click="markDone(t)"
                                    class="w-8 h-8 rounded bg-green-500/20 text-green-400">âœ“</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Subject Tabs -->
            <template x-for="subj in ['medicine','pediatrics']" :key="subj">
                <div x-show="tab===subj">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold" x-text="subj==='medicine'?'ğŸ«€ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©':'ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„'"></h2>
                            <p class="text-gray-400 text-sm"
                                x-text="'Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: '+getStats(subj).done+'/'+getStats(subj).total+' â€¢ Ø§Ù„Ø³Ø§Ø¹Ø§Øª: '+getStats(subj).hDone+'/'+getStats(subj).hTotal">
                            </p>
                        </div>
                        <span class="text-2xl font-bold" :class="subj==='medicine'?'text-purple-400':'text-cyan-400'"
                            x-text="getProgress(subj)+'%'"></span>
                    </div>
                    <div class="space-y-4">
                        <template x-for="(ch,ci) in data[subj]" :key="ch.id">
                            <div class="glass rounded-2xl overflow-hidden" :class="ch.ignored?'dimmed':''">
                                <button @click="openCh[subj+ci]=!openCh[subj+ci]"
                                    class="w-full p-4 flex items-center justify-between hover:bg-white/5">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl" x-text="ch.icon"></span>
                                        <div>
                                            <h3 class="font-bold" x-text="ch.name"></h3>
                                            <p class="text-xs text-gray-400"
                                                x-text="getChProg(subj,ci)+'% â€¢ '+getChHrs(subj,ci)+' Ø³Ø§Ø¹Ø©'"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click.stop="ch.ignored=!ch.ignored;save()"
                                            class="w-7 h-7 rounded text-sm"
                                            :class="ch.ignored?'bg-gray-500 text-white':'bg-gray-700 text-gray-400'">ğŸ‘</button>
                                        <div class="w-20 h-2 bg-gray-700 rounded-full hidden sm:block">
                                            <div class="h-full rounded-full"
                                                :class="subj==='medicine'?'progress-purple':'progress-cyan'"
                                                :style="'width:'+getChProg(subj,ci)+'%'"></div>
                                        </div>
                                        <span x-text="openCh[subj+ci]?'â–²':'â–¼'" class="text-xs"></span>
                                    </div>
                                </button>
                                <div class="acc-content border-t border-white/5" :class="openCh[subj+ci]?'open':''">
                                    <template x-for="(lec,li) in ch.lectures" :key="lec.id">
                                        <div class="flex items-center justify-between p-3 hover:bg-white/5 border-b border-white/10"
                                            :class="lec.ignored?'dimmed':''">
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded text-xs flex items-center justify-center"
                                                    :class="lec.done?'bg-green-500 text-white':'bg-gray-700 text-gray-400'"
                                                    x-text="li+1"></span>
                                                <div>
                                                    <p class="text-sm" :class="lec.done?'line-through text-gray-500':''"
                                                        x-text="lec.title"></p>
                                                    <p class="text-xs text-gray-500" x-text="lec.duration+' Ø¯Ù‚ÙŠÙ‚Ø©'"></p>
                                                </div>
                                            </div>
                                            <div class="flex gap-1">
                                                <button @click="lec.done=!lec.done;save()"
                                                    class="w-7 h-7 rounded text-sm"
                                                    :class="lec.done?'bg-green-500 text-white':'bg-gray-700 text-gray-400'">âœ“</button>
                                                <button @click="lec.ignored=!lec.ignored;save()"
                                                    class="w-7 h-7 rounded text-sm"
                                                    :class="lec.ignored?'bg-gray-500 text-white':'bg-gray-700 text-gray-400'">ğŸ‘</button>
                                                <button @click="lec.review=!lec.review;save()"
                                                    class="w-7 h-7 rounded text-sm"
                                                    :class="lec.review?'bg-red-500 text-white':'bg-gray-700 text-gray-400'">â­</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Settings -->
            <div x-show="tab==='settings'" class="max-w-xl mx-auto space-y-4">
                <h2 class="text-2xl font-bold mb-4">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                <div class="glass rounded-xl p-4">
                    <label class="text-gray-400 text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label>
                    <input type="date" x-model="settings.examDate" @change="save()"
                        class="w-full bg-gray-800 rounded-lg px-4 py-2 mt-1">
                </div>
                <div class="glass rounded-xl p-4">
                    <label class="text-gray-400 text-sm">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</label>
                    <input type="date" x-model="settings.startDate" @change="save()"
                        class="w-full bg-gray-800 rounded-lg px-4 py-2 mt-1">
                </div>
                <div class="glass rounded-xl p-4">
                    <label class="text-gray-400 text-sm">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø³Ø§Ø¹Ø§Øª)</label>
                    <input type="number" x-model.number="settings.dailyTarget" @change="save()"
                        class="w-full bg-gray-800 rounded-lg px-4 py-2 mt-1">
                </div>
                <div class="glass rounded-xl p-4 border border-red-500/30">
                    <button @click="resetAll()" class="text-red-400">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const DEFAULT_DATA = {
            medicine: [
                {
                    id: 'm1', name: 'Neurology', icon: 'ğŸ§ ', ignored: false, lectures: [
                        { id: 'm1a', title: 'Neurology Intro', duration: 30, done: false, ignored: false, review: false },
                        { id: 'm1b', title: 'Stroke Part 1', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm1c', title: 'Stroke Part 2', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm1d', title: 'Epilepsy', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm1e', title: 'Headache', duration: 35, done: false, ignored: false, review: false },
                        { id: 'm1f', title: 'Multiple Sclerosis', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm1g', title: 'CNS Infections', duration: 55, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm2', name: 'Cardiology', icon: 'â¤ï¸', ignored: false, lectures: [
                        { id: 'm2a', title: 'Cardiology Basics', duration: 30, done: false, ignored: false, review: false },
                        { id: 'm2b', title: 'Ischemic Heart Disease', duration: 60, done: false, ignored: false, review: false },
                        { id: 'm2c', title: 'Heart Failure', duration: 55, done: false, ignored: false, review: false },
                        { id: 'm2d', title: 'Arrhythmia', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm2e', title: 'Valvular Heart Disease', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm2f', title: 'Hypertension', duration: 40, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm3', name: 'Nephrology', icon: 'ğŸ«˜', ignored: false, lectures: [
                        { id: 'm3a', title: 'Nephrology Intro', duration: 30, done: false, ignored: false, review: false },
                        { id: 'm3b', title: 'Acute Kidney Injury', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm3c', title: 'Chronic Kidney Disease', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm3d', title: 'Glomerulonephritis', duration: 60, done: false, ignored: false, review: false },
                        { id: 'm3e', title: 'Acid Base Balance', duration: 40, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm4', name: 'Endocrinology', icon: 'ğŸ¦‹', ignored: false, lectures: [
                        { id: 'm4a', title: 'Diabetes Part 1', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm4b', title: 'Diabetes Part 2', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm4c', title: 'Thyroid Disorders', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm4d', title: 'Adrenal Gland', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm4e', title: 'Pituitary Disorders', duration: 35, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm5', name: 'Hematology', icon: 'ğŸ©¸', ignored: false, lectures: [
                        { id: 'm5a', title: 'Anemia Approach', duration: 30, done: false, ignored: false, review: false },
                        { id: 'm5b', title: 'Iron Deficiency', duration: 25, done: false, ignored: false, review: false },
                        { id: 'm5c', title: 'Hemolytic Anemia', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm5d', title: 'Leukemia', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm5e', title: 'Lymphoma', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm5f', title: 'Bleeding Disorders', duration: 40, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm6', name: 'Pulmonology', icon: 'ğŸ«', ignored: false, lectures: [
                        { id: 'm6a', title: 'Pneumonia', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm6b', title: 'Asthma', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm6c', title: 'COPD', duration: 35, done: false, ignored: false, review: false },
                        { id: 'm6d', title: 'TB', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm6e', title: 'Pleural Effusion', duration: 30, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm7', name: 'Gastroenterology', icon: 'ğŸ«ƒ', ignored: false, lectures: [
                        { id: 'm7a', title: 'Liver Cirrhosis', duration: 50, done: false, ignored: false, review: false },
                        { id: 'm7b', title: 'Hepatitis', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm7c', title: 'IBD', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm7d', title: 'Peptic Ulcer', duration: 30, done: false, ignored: false, review: false }]
                },
                {
                    id: 'm8', name: 'Rheumatology', icon: 'ğŸ¦´', ignored: false, lectures: [
                        { id: 'm8a', title: 'SLE', duration: 45, done: false, ignored: false, review: false },
                        { id: 'm8b', title: 'Rheumatoid Arthritis', duration: 40, done: false, ignored: false, review: false },
                        { id: 'm8c', title: 'Vasculitis', duration: 35, done: false, ignored: false, review: false }]
                }
            ],
            pediatrics: [
                {
                    id: 'p1', name: 'Endocrinology', icon: 'ğŸ¦‹', ignored: false, lectures: [
                        { id: 'p1a', title: 'Rickets', duration: 31, done: false, ignored: false, review: false },
                        { id: 'p1b', title: 'Hypoglycemia', duration: 20, done: false, ignored: false, review: false },
                        { id: 'p1c', title: 'Growth', duration: 21, done: false, ignored: false, review: false },
                        { id: 'p1d', title: 'Diabetes Part 1', duration: 39, done: false, ignored: false, review: false },
                        { id: 'p1e', title: 'Diabetes Part 2', duration: 41, done: false, ignored: false, review: false },
                        { id: 'p1f', title: 'DKA', duration: 42, done: false, ignored: false, review: false },
                        { id: 'p1g', title: 'Thyroid Disorders', duration: 56, done: false, ignored: false, review: false },
                        { id: 'p1h', title: 'Short Stature', duration: 17, done: false, ignored: false, review: false }]
                },
                {
                    id: 'p2', name: 'Neurology', icon: 'ğŸ§ ', ignored: false, lectures: [
                        { id: 'p2a', title: 'Meningitis Part 1', duration: 28, done: false, ignored: false, review: false },
                        { id: 'p2b', title: 'Guillain Barre', duration: 26, done: false, ignored: false, review: false },
                        { id: 'p2c', title: 'Cerebral Palsy', duration: 36, done: false, ignored: false, review: false },
                        { id: 'p2d', title: 'Seizures Part 1', duration: 30, done: false, ignored: false, review: false },
                        { id: 'p2e', title: 'Seizures Part 2', duration: 25, done: false, ignored: false, review: false }]
                },
                {
                    id: 'p3', name: 'Hematology', icon: 'ğŸ©¸', ignored: false, lectures: [
                        { id: 'p3a', title: 'Anemia Approach', duration: 25, done: false, ignored: false, review: false },
                        { id: 'p3b', title: 'Iron Deficiency', duration: 25, done: false, ignored: false, review: false },
                        { id: 'p3c', title: 'Thalassemia', duration: 30, done: false, ignored: false, review: false },
                        { id: 'p3d', title: 'Sickle Cell', duration: 23, done: false, ignored: false, review: false },
                        { id: 'p3e', title: 'Leukemia', duration: 28, done: false, ignored: false, review: false }]
                },
                {
                    id: 'p4', name: 'Neonatology', icon: 'ğŸ‘¶', ignored: false, lectures: [
                        { id: 'p4a', title: 'Neonatal Sepsis', duration: 42, done: false, ignored: false, review: false },
                        { id: 'p4b', title: 'Respiratory Distress', duration: 32, done: false, ignored: false, review: false },
                        { id: 'p4c', title: 'Prematurity', duration: 32, done: false, ignored: false, review: false },
                        { id: 'p4d', title: 'Neonatal Seizures', duration: 31, done: false, ignored: false, review: false },
                        { id: 'p4e', title: 'HIE', duration: 40, done: false, ignored: false, review: false },
                        { id: 'p4f', title: 'Neonatal Exam', duration: 97, done: false, ignored: false, review: false }]
                },
                {
                    id: 'p5', name: 'Emergency', icon: 'ğŸš¨', ignored: false, lectures: [
                        { id: 'p5a', title: 'Pediatric PLS', duration: 22, done: false, ignored: false, review: false },
                        { id: 'p5b', title: 'PALS', duration: 10, done: false, ignored: false, review: false },
                        { id: 'p5c', title: 'Anaphylaxis', duration: 9, done: false, ignored: false, review: false },
                        { id: 'p5d', title: 'Poisoning', duration: 20, done: false, ignored: false, review: false },
                        { id: 'p5e', title: 'Dehydration', duration: 40, done: false, ignored: false, review: false },
                        { id: 'p5f', title: 'Gastroenteritis', duration: 30, done: false, ignored: false, review: false }]
                }
            ]
        };

        function app() {
            return {
                loading: true, user: null, tab: 'dashboard', unsub: null, openCh: {},
                settings: { examDate: '2026-04-15', startDate: '2026-02-01', dailyTarget: 3 },
                data: { medicine: [], pediatrics: [] },

                async init() {
                    this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    const ready = () => { window.fb.onAuthStateChanged(window.fb.auth, async u => { this.user = u; if (u) await this.load(); this.loading = false }) };
                    if (window.fb) ready(); else window.addEventListener('fb-ready', ready);
                },
                async login() { try { await window.fb.signInWithPopup(window.fb.auth, window.fb.provider) } catch (e) { alert(e.message) } },
                async logout() { if (this.unsub) this.unsub(); await window.fb.signOut(window.fb.auth); this.user = null },
                async load() {
                    const ref = window.fb.doc(window.fb.db, 'users', this.user.uid);
                    this.unsub = window.fb.onSnapshot(ref, d => {
                        if (d.exists()) {
                            const u = d.data();
                            if (u.data && u.data.medicine && u.data.medicine.length > 0) { this.data = u.data }
                            if (u.settings) this.settings = u.settings;
                        } else { this.save() }
                    });
                },
                async save() { if (!this.user) return; await window.fb.setDoc(window.fb.doc(window.fb.db, 'users', this.user.uid), { data: this.data, settings: this.settings }, { merge: true }) },

                get daysToExam() { return Math.max(0, Math.ceil((new Date(this.settings.examDate) - new Date()) / (86400000))) },
                get daysInPlan() { const total = Math.ceil((new Date(this.settings.examDate) - new Date(this.settings.startDate)) / (86400000)); return Math.max(0, total) },
                get daysPassed() { return Math.max(0, Math.ceil((new Date() - new Date(this.settings.startDate)) / (86400000))) },

                get totalHours() { let t = 0;['medicine', 'pediatrics'].forEach(s => this.data[s].forEach(c => c.lectures.forEach(l => { if (!l.ignored && !c.ignored) t += l.duration }))); return (t / 60).toFixed(1) },
                get hoursDone() { let t = 0;['medicine', 'pediatrics'].forEach(s => this.data[s].forEach(c => c.lectures.forEach(l => { if (l.done) t += l.duration }))); return (t / 60).toFixed(1) },
                get totalProgress() { const t = parseFloat(this.totalHours), d = parseFloat(this.hoursDone); return t > 0 ? Math.round(d / t * 100) : 0 },

                getMedProgress() { return this.getProgress('medicine') },
                getPedProgress() { return this.getProgress('pediatrics') },
                getProgress(s) { let t = 0, d = 0; this.data[s].forEach(c => { if (!c.ignored) c.lectures.forEach(l => { if (!l.ignored) { t++; if (l.done) d++ } }) }); return t ? Math.round(d / t * 100) : 0 },
                getStats(s) { let t = 0, d = 0, ht = 0, hd = 0; this.data[s].forEach(c => c.lectures.forEach(l => { t++; ht += l.duration; if (l.done) { d++; hd += l.duration } })); return { total: t, done: d, hTotal: (ht / 60).toFixed(1), hDone: (hd / 60).toFixed(1) } },
                getChProg(s, i) { const lecs = this.data[s][i].lectures.filter(l => !l.ignored); if (!lecs.length) return 0; return Math.round(lecs.filter(l => l.done).length / lecs.length * 100) },
                getChHrs(s, i) { return (this.data[s][i].lectures.reduce((a, l) => a + l.duration, 0) / 60).toFixed(1) },

                get expectedHours() { const total = this.daysPassed + this.daysToExam; if (!total) return 0; return (parseFloat(this.totalHours) / total) * this.daysPassed },
                get delayHours() { return Math.max(0, this.expectedHours - parseFloat(this.hoursDone)) },
                get extraMinutes() { return this.daysToExam > 0 ? Math.round(this.delayHours * 60 / this.daysToExam) : 0 },
                get status() { return this.delayHours > 0 ? 'behind' : 'ontrack' },

                getTodayTasks(subj) {
                    const tasks = []; let mins = 0; const target = this.settings.dailyTarget * 60 / 2;
                    for (const ch of this.data[subj]) {
                        if (ch.ignored) continue;
                        for (const l of ch.lectures) {
                            if (!l.done && !l.ignored && mins < target) {
                                tasks.push({ ...l, subject: subj, chapter: ch.name, chapterId: ch.id });
                                mins += l.duration;
                            }
                        }
                    }
                    return tasks;
                },
                get catchupTasks() {
                    if (this.delayHours <= 0) return [];
                    const tasks = []; let mins = 0; const target = this.extraMinutes;
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s]) {
                            if (ch.ignored) continue;
                            for (const l of ch.lectures) {
                                if (!l.done && !l.ignored && mins < target) {
                                    const already = [...this.getTodayTasks('medicine'), ...this.getTodayTasks('pediatrics')].find(t => t.id === l.id);
                                    if (!already) { tasks.push({ ...l, subject: s, chapter: ch.name }); mins += l.duration }
                                }
                            }
                        }
                    }
                    return tasks;
                },
                markDone(task) {
                    for (const s of ['medicine', 'pediatrics']) {
                        for (const ch of this.data[s]) {
                            for (const l of ch.lectures) {
                                if (l.id === task.id) { l.done = true; this.save(); return }
                            }
                        }
                    }
                },
                resetAll() { if (confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) { this.data = JSON.parse(JSON.stringify(DEFAULT_DATA)); this.save() } }
            }
        }
    </script>
</body>

</html>