<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>The Last Term</title><script src="https://cdn.tailwindcss.com"></script><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script><style>*{font-family:'Tajawal',sans-serif}.glass{background:rgba(30,41,59,.8);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}.sortable-ghost{opacity:.4;background:#4f46e5!important}.lecture-ignored{opacity:.5;text-decoration:line-through}.modal{animation:fadeIn .2s}@keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}</style></head>
<body class="bg-slate-900 text-slate-200 min-h-screen">
<div id="authScreen" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-50">
    <div class="text-center glass rounded-2xl p-12 max-w-md mx-4">
        <div class="text-6xl mb-6">📚</div>
        <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-amber-400 to-orange-500 bg-clip-text text-transparent">The Last Term</h1>
        <p class="text-slate-400 mb-8">نظام إدارة المذاكرة الذكي</p>
        <button id="googleSignIn" class="flex items-center justify-center gap-3 w-full bg-white text-gray-800 font-medium py-3 px-6 rounded-xl hover:bg-gray-100">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            تسجيل الدخول بواسطة Google
        </button>
    </div>
</div>
<div id="mainApp" class="hidden">
    <header class="glass sticky top-0 z-40 px-6 py-4">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center gap-4"><button id="menuToggle" class="md:hidden text-2xl">☰</button><h1 class="text-xl font-bold">📚 The Last Term</h1></div>
            <div class="flex items-center gap-4"><span id="userEmail" class="text-sm text-slate-400 hidden sm:block"></span><button id="settingsBtn" class="text-2xl hover:text-amber-400">⚙️</button><button id="signOutBtn" class="text-sm bg-red-600/20 text-red-400 px-3 py-1 rounded-lg hover:bg-red-600/30">خروج</button></div>
        </div>
    </header>
    <div class="flex max-w-7xl mx-auto">
        <aside id="sidebar" class="w-64 glass m-4 rounded-xl p-4 hidden md:block">
            <h2 class="text-lg font-bold mb-4 text-amber-400">📖 المواد</h2>
            <div id="subjectsList" class="space-y-2"></div>
            <button id="addSubjectBtn" class="w-full mt-4 py-2 border-2 border-dashed border-slate-600 rounded-lg hover:border-amber-400 hover:text-amber-400">+ إضافة مادة</button>
        </aside>
        <main class="flex-1 p-4">
            <div id="dashboard">
                <div class="glass rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">🎯 المهمة اليومية</h2><div id="dailyTarget" class="text-3xl font-bold text-amber-400 mb-4">جاري الحساب...</div><div id="todayLectures" class="space-y-2"></div></div>
                <div id="backlogCard" class="hidden glass rounded-xl p-6 mb-4 border-2 border-red-500 bg-red-900/20"><h2 class="text-xl font-bold mb-2 text-red-400">⚠️ تنبيه التأخير</h2><p id="backlogMessage" class="text-red-300"></p></div>
                <div class="glass rounded-xl p-6 mb-4"><h2 class="text-xl font-bold mb-4">📊 نظرة عامة</h2><div id="progressStats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></div>
            </div>
            <div id="subjectContent" class="hidden">
                <div class="flex items-center justify-between mb-4"><h2 id="subjectTitle" class="text-2xl font-bold"></h2><button id="backToDashboard" class="text-slate-400 hover:text-white">← العودة للوحة التحكم</button></div>
                <div id="chaptersContainer" class="space-y-4"></div>
                <button id="addChapterBtn" class="w-full mt-4 py-3 border-2 border-dashed border-slate-600 rounded-xl hover:border-indigo-400 hover:text-indigo-400">+ إضافة فصل جديد</button>
            </div>
        </main>
    </div>
</div>
<div id="adminModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="modal glass rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold">⚙️ الإعدادات</h2><button id="closeAdminModal" class="text-2xl hover:text-red-400">✕</button></div>
        <div class="mb-6 p-4 bg-slate-800/50 rounded-xl"><h3 class="font-bold mb-3">➕ إضافة مادة جديدة</h3><input id="newSubjectName" type="text" placeholder="اسم المادة" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"><input id="newSubjectDate" type="date" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"><button id="createSubjectBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">إنشاء المادة</button></div>
        <div class="mb-6 p-4 bg-slate-800/50 rounded-xl"><h3 class="font-bold mb-3">📝 المحلل الذكي</h3><p class="text-sm text-slate-400 mb-2">الصق قائمة المحاضرات (اسم - دقائق)</p><select id="parserSubject" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"><option value="">اختر المادة</option></select><input id="parserChapter" type="text" placeholder="اسم الفصل" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"><textarea id="lecturesText" rows="6" placeholder="محاضرة 1 - 30&#10;محاضرة 2 - 45" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"></textarea><button id="parseLecturesBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">تحليل وإضافة</button></div>
    </div>
</div>
<div id="chapterModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="modal glass rounded-2xl p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">إضافة فصل</h3><input id="chapterName" type="text" placeholder="اسم الفصل" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-4 text-white"><div class="flex gap-2"><button id="saveChapterBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">حفظ</button><button id="cancelChapterBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">إلغاء</button></div></div>
</div>
<div id="lectureModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="modal glass rounded-2xl p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">إضافة محاضرة</h3><input id="lectureName" type="text" placeholder="اسم المحاضرة" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-2 text-white"><input id="lectureDuration" type="number" placeholder="المدة (دقائق)" class="w-full bg-slate-700 rounded-lg px-4 py-2 mb-4 text-white"><div class="flex gap-2"><button id="saveLectureBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">حفظ</button><button id="cancelLectureBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">إلغاء</button></div></div>
</div>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import{getFirestore,doc,getDoc,setDoc,onSnapshot}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
const firebaseConfig={apiKey:"AIzaSyBpMhO7a6p4ktKjoEta1MOTSLF345eIsRQ",authDomain:"the-last-turn.firebaseapp.com",projectId:"the-last-turn",storageBucket:"the-last-turn.firebasestorage.app",messagingSenderId:"747668413856",appId:"1:747668413856:web:6c67a8b56e7bdec53d58c5"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),provider=new GoogleAuthProvider();
let currentUser=null,userData={subjects:[]},currentSubjectId=null,currentChapterId=null,unsubscribe=null;
const $=id=>document.getElementById(id);
$('googleSignIn').onclick=async()=>{try{await signInWithPopup(auth,provider)}catch(e){alert('خطأ: '+e.message)}};
$('signOutBtn').onclick=async()=>{if(unsubscribe)unsubscribe();await signOut(auth)};
onAuthStateChanged(auth,async user=>{if(user){currentUser=user;$('authScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');$('userEmail').textContent=user.email;await initUserData()}else{currentUser=null;$('authScreen').classList.remove('hidden');$('mainApp').classList.add('hidden')}});
async function initUserData(){const userRef=doc(db,'users',currentUser.uid);const docSnap=await getDoc(userRef);if(!docSnap.exists())await setDoc(userRef,{subjects:[]});unsubscribe=onSnapshot(userRef,doc=>{if(doc.exists()){userData=doc.data();renderApp()}},err=>alert('خطأ: '+err.message))}
async function saveData(){try{await setDoc(doc(db,'users',currentUser.uid),userData)}catch(e){alert('خطأ: '+e.message)}}
function renderApp(){renderSubjectsList();renderDashboard();renderParserSubjects();if(currentSubjectId)renderSubjectContent()}
function renderSubjectsList(){$('subjectsList').innerHTML=userData.subjects.map(s=>`<button onclick="window.openSubject('${s.id}')" class="w-full text-right p-3 rounded-lg hover:bg-slate-700 ${currentSubjectId===s.id?'bg-indigo-600':''}">${s.name}<span class="text-xs text-slate-400 block">${formatDate(s.examDate)}</span></button>`).join('')}
function renderDashboard(){let totalMinutes=0,watchedMinutes=0,totalLectures=0,earliestExam=null;const todayLectures=[];userData.subjects.forEach(s=>{if(!earliestExam||new Date(s.examDate)<new Date(earliestExam))earliestExam=s.examDate;s.chapters?.forEach(c=>{c.lectures?.forEach(l=>{if(!l.ignored){totalMinutes+=l.duration||0;totalLectures++;if(l.videoWatched)watchedMinutes+=l.duration||0;else todayLectures.push({...l,subject:s.name})}})})});const remainingMinutes=totalMinutes-watchedMinutes,daysLeft=earliestExam?Math.max(1,Math.ceil((new Date(earliestExam)-new Date())/86400000)):30,dailyHours=(remainingMinutes/60/daysLeft).toFixed(1);$('dailyTarget').textContent=`هدف اليوم: ${dailyHours} ساعة`;let acc=0;const target=dailyHours*60,forToday=[];for(const l of todayLectures){if(acc>=target)break;forToday.push(l);acc+=l.duration||0}$('todayLectures').innerHTML=forToday.slice(0,5).map(l=>`<div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg"><span>${l.name} <span class="text-xs text-slate-400">(${l.subject})</span></span><span class="text-amber-400">${l.duration}د</span></div>`).join('')||'<p class="text-slate-400">🎉 لا محاضرات لليوم</p>';const expected=0.5,actual=totalMinutes>0?watchedMinutes/totalMinutes:0,behind=((expected-actual)*totalMinutes/60).toFixed(1);if(behind>0&&totalMinutes>0){$('backlogCard').classList.remove('hidden');$('backlogMessage').textContent=`متأخر ${behind} ساعة!`}else $('backlogCard').classList.add('hidden');$('progressStats').innerHTML=`<div class="text-center p-4 bg-slate-800/50 rounded-xl"><div class="text-2xl font-bold text-amber-400">${(totalMinutes/60).toFixed(1)}</div><div class="text-sm text-slate-400">إجمالي</div></div><div class="text-center p-4 bg-slate-800/50 rounded-xl"><div class="text-2xl font-bold text-green-400">${(watchedMinutes/60).toFixed(1)}</div><div class="text-sm text-slate-400">مكتمل</div></div><div class="text-center p-4 bg-slate-800/50 rounded-xl"><div class="text-2xl font-bold text-indigo-400">${totalLectures}</div><div class="text-sm text-slate-400">محاضرات</div></div><div class="text-center p-4 bg-slate-800/50 rounded-xl"><div class="text-2xl font-bold text-red-400">${daysLeft}</div><div class="text-sm text-slate-400">أيام</div></div>`}
window.openSubject=id=>{currentSubjectId=id;$('dashboard').classList.add('hidden');$('subjectContent').classList.remove('hidden');renderSubjectContent();renderSubjectsList()};
$('backToDashboard').onclick=()=>{currentSubjectId=null;$('dashboard').classList.remove('hidden');$('subjectContent').classList.add('hidden');renderSubjectsList()};
function renderSubjectContent(){const s=userData.subjects.find(x=>x.id===currentSubjectId);if(!s)return;$('subjectTitle').textContent=s.name;$('chaptersContainer').innerHTML=s.chapters?.map(c=>`<div class="glass rounded-xl p-6 mb-4" data-chapter="${c.id}"><div class="flex items-center justify-between mb-4 cursor-move handle"><h3 class="font-bold text-lg">📁 ${c.name}</h3><button onclick="window.deleteChapter('${c.id}')" class="text-red-400">🗑️</button></div><div class="space-y-2">${c.lectures?.map(l=>`<div class="flex items-center gap-3 p-3 ${l.ignored?'lecture-ignored':''} bg-slate-800/50 rounded-lg"><input type="checkbox" ${l.videoWatched?'checked':''} onchange="window.toggleVideo('${c.id}','${l.id}')" class="w-5 h-5 accent-green-500"><input type="checkbox" ${l.notesTaken?'checked':''} onchange="window.toggleNotes('${c.id}','${l.id}')" class="w-5 h-5 accent-blue-500" title="ملاحظات"><span class="flex-1">${l.name}</span><span class="text-amber-400 text-sm">${l.duration}د</span><button onclick="window.toggleIgnore('${c.id}','${l.id}')" class="text-xl ${l.ignored?'text-slate-500':'text-slate-400'}">👁️</button><button onclick="window.toggleReview('${c.id}','${l.id}')" class="text-xl ${l.needsReview?'text-yellow-400':'text-slate-400'}">⭐</button><button onclick="window.deleteLecture('${c.id}','${l.id}')" class="text-red-400">✕</button></div>`).join('')||'<p class="text-slate-500">لا محاضرات</p>'}</div><button onclick="window.openAddLecture('${c.id}')" class="mt-3 text-sm text-indigo-400">+ إضافة محاضرة</button></div>`).join('')||'<p class="text-slate-400">لا فصول</p>';new Sortable($('chaptersContainer'),{handle:'.handle',ghostClass:'sortable-ghost',onEnd:async e=>{const s=userData.subjects.find(x=>x.id===currentSubjectId);const[m]=s.chapters.splice(e.oldIndex,1);s.chapters.splice(e.newIndex,0,m);await saveData()}})}
window.toggleVideo=async(cid,lid)=>{const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===cid);const l=c.lectures.find(x=>x.id===lid);l.videoWatched=!l.videoWatched;await saveData()};
window.toggleNotes=async(cid,lid)=>{const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===cid);const l=c.lectures.find(x=>x.id===lid);l.notesTaken=!l.notesTaken;await saveData()};
window.toggleIgnore=async(cid,lid)=>{const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===cid);const l=c.lectures.find(x=>x.id===lid);l.ignored=!l.ignored;await saveData()};
window.toggleReview=async(cid,lid)=>{const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===cid);const l=c.lectures.find(x=>x.id===lid);l.needsReview=!l.needsReview;await saveData()};
window.deleteLecture=async(cid,lid)=>{if(!confirm('حذف المحاضرة؟'))return;const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===cid);c.lectures=c.lectures.filter(x=>x.id!==lid);await saveData()};
window.deleteChapter=async cid=>{if(!confirm('حذف الفصل؟'))return;const s=userData.subjects.find(x=>x.id===currentSubjectId);s.chapters=s.chapters.filter(x=>x.id!==cid);await saveData()};
$('addChapterBtn').onclick=()=>$('chapterModal').classList.remove('hidden');$('cancelChapterBtn').onclick=()=>$('chapterModal').classList.add('hidden');
$('saveChapterBtn').onclick=async()=>{const n=$('chapterName').value.trim();if(!n)return alert('أدخل الاسم');const s=userData.subjects.find(x=>x.id===currentSubjectId);if(!s.chapters)s.chapters=[];s.chapters.push({id:Date.now().toString(),name:n,lectures:[]});$('chapterName').value='';$('chapterModal').classList.add('hidden');await saveData()};
window.openAddLecture=cid=>{currentChapterId=cid;$('lectureModal').classList.remove('hidden')};$('cancelLectureBtn').onclick=()=>$('lectureModal').classList.add('hidden');
$('saveLectureBtn').onclick=async()=>{const n=$('lectureName').value.trim(),d=parseInt($('lectureDuration').value)||0;if(!n)return alert('أدخل الاسم');const s=userData.subjects.find(x=>x.id===currentSubjectId);const c=s.chapters.find(x=>x.id===currentChapterId);if(!c.lectures)c.lectures=[];c.lectures.push({id:Date.now().toString(),name:n,duration:d,videoWatched:false,notesTaken:false,ignored:false,needsReview:false});$('lectureName').value='';$('lectureDuration').value='';$('lectureModal').classList.add('hidden');await saveData()};
$('settingsBtn').onclick=()=>$('adminModal').classList.remove('hidden');$('closeAdminModal').onclick=()=>$('adminModal').classList.add('hidden');
$('createSubjectBtn').onclick=async()=>{const n=$('newSubjectName').value.trim(),d=$('newSubjectDate').value;if(!n||!d)return alert('أدخل البيانات');userData.subjects.push({id:Date.now().toString(),name:n,examDate:d,chapters:[]});$('newSubjectName').value='';$('newSubjectDate').value='';await saveData()};
function renderParserSubjects(){$('parserSubject').innerHTML='<option value="">اختر المادة</option>'+userData.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
$('parseLecturesBtn').onclick=async()=>{const sid=$('parserSubject').value,cn=$('parserChapter').value.trim(),txt=$('lecturesText').value.trim();if(!sid||!cn||!txt)return alert('أكمل البيانات');const lecs=txt.split('\n').filter(l=>l.trim()).map(line=>{const m=line.match(/(.+?)\s*[-–]\s*(\d+)/);if(m)return{id:Date.now().toString()+Math.random(),name:m[1].trim(),duration:parseInt(m[2]),videoWatched:false,notesTaken:false,ignored:false,needsReview:false};return null}).filter(Boolean);if(!lecs.length)return alert('لم يتم التعرف على محاضرات');const s=userData.subjects.find(x=>x.id===sid);if(!s.chapters)s.chapters=[];s.chapters.push({id:Date.now().toString(),name:cn,lectures:lecs});$('parserChapter').value='';$('lecturesText').value='';alert(`تم إضافة ${lecs.length} محاضرة!`);await saveData()};
function formatDate(d){if(!d)return'';return new Date(d).toLocaleDateString('ar-EG',{year:'numeric',month:'short',day:'numeric'})}
$('menuToggle').onclick=()=>$('sidebar').classList.toggle('hidden');$('addSubjectBtn').onclick=()=>$('adminModal').classList.remove('hidden');
</script>
</body>
</html>
